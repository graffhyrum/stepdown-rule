<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session b131778c-b1a9-4d27-8ed8-33e9f7ec2064 (2026-02-14 00:47Z) -->

# Stepdown violation analysis and remediation (2026-02-14 00:47Z)

_**User**_

The analyzer found a violation:
src/analyzer.ts:61:1 - Stepdown violation: analyzeWithRules calls buildRuleContext which appears above it
  call site: src/analyzer.ts:65:14
  dependency declared at: src/analyzer.ts:38:1
but the fixer didn't fix it. 
Perform RCA and make a remediation plan

---

_**Agent (model default, mode Agent)**_

<think><details><summary>Thought Process</summary>

The user is reporting that the analyzer found a stepdown violation in the codebase: `analyzeWithRules` calls `buildRuleContext` which appears above it (violating the stepdown rule - high-level functions should call lower-level functions that appear below them in the file). The fixer didn't fix it.

They want:
1. Root cause analysis (RCA)
2. A remediation plan

I'm in plan mode, so I need to:
1. Understand the codebase - how the analyzer and fixer work
2. Understand why the fixer didn't fix this violation
3. Create an RCA and remediation plan
4. Use CreatePlan to present it

Let me search for the relevant code: analyzer, fixer, stepdown rule, buildRuleContext, analyzeWithRules.
</details></think>

---


Investigating the analyzer, fixer, and stepdown rule to determine why the fixer didn't resolve the violation.


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /home/graff/WebstormProjects/stepdown-rule/src/analyzer.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "stepdown|fixer|fix",
  "path": "/home/graff/WebstormProjects/stepdown-rule/src",
  "glob": "*.ts",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "stepdown|fixer|fix",
    "path": "/home/graff/WebstormProjects/stepdown-rule/src",
    "outputMode": "content",
    "workspaceResults": {
      "/home/graff/WebstormProjects/stepdown-rule": {
        "content": {
          "matches": [
            {
              "file": "src/rule-context.ts",
              "matches": [
                {
                  "lineNumber": 21,
                  "content": "\tfix(ctx: RuleContext, violations: Violation[]): string;"
                }
              ]
            },
            {
              "file": "src/nested-rule.ts",
              "matches": [
                {
                  "lineNumber": 2,
                  "content": "import { applyNestedOnly } from \"./fixer\";"
                },
                {
                  "lineNumber": 10,
                  "content": "\tfix(ctx: RuleContext, _violations: Violation[]): string {"
                }
              ]
            },
            {
              "file": "src/fixer.ts",
              "matches": [
                {
                  "lineNumber": 11,
                  "content": "\tfixResults: FixResult[];"
                },
                {
                  "lineNumber": 25,
                  "content": "\tconst fixResults: FixResult[] = [];"
                },
                {
                  "lineNumber": 28,
                  "content": "\t\tconst { analysisResult, fixResult } = await processOneFile({"
                },
                {
                  "lineNumber": 36,
                  "content": "\t\tif (config.fix &amp;&amp; fixResult) {"
                },
                {
                  "lineNumber": 37,
                  "content": "\t\t\tfixResults.push(fixResult);"
                },
                {
                  "lineNumber": 41,
                  "content": "\treturn { analysisResults, fixResults };"
                },
                {
                  "lineNumber": 50,
                  "content": "}): Promise&lt;{ analysisResult: AnalysisResult; fixResult: FixResult | null }&gt; {"
                },
                {
                  "lineNumber": 57,
                  "content": "\tif (!config.fix) {"
                },
                {
                  "lineNumber": 58,
                  "content": "\t\treturn { analysisResult, fixResult: null };"
                },
                {
                  "lineNumber": 63,
                  "content": "\t\tconst result = fixFileWithRules({"
                },
                {
                  "lineNumber": 69,
                  "content": "\t\tif (result.fixed) {"
                },
                {
                  "lineNumber": 70,
                  "content": "\t\t\tawait service.writeFile(filePath, result.fixedContent);"
                },
                {
                  "lineNumber": 72,
                  "content": "\t\treturn { analysisResult, fixResult: result };"
                },
                {
                  "lineNumber": 75,
                  "content": "\tconst fixResult = await processAndFixLegacy(analysisResult, config, service);"
                },
                {
                  "lineNumber": 76,
                  "content": "\treturn { analysisResult, fixResult };"
                },
                {
                  "lineNumber": 87,
                  "content": "export async function fixFiles("
                },
                {
                  "lineNumber": 92,
                  "content": "\tconst { fixResults } = await runPipeline(patterns, { ...config, fix: true }, fileService);"
                },
                {
                  "lineNumber": 93,
                  "content": "\treturn fixResults;"
                },
                {
                  "lineNumber": 96,
                  "content": "export function fixFileWithRules(params: {"
                },
                {
                  "lineNumber": 109,
                  "content": "\t\t\tcontent = rule.fix(ctx, violations);"
                },
                {
                  "lineNumber": 112,
                  "content": "\tconst fixed = content !== originalContent;"
                },
                {
                  "lineNumber": 115,
                  "content": "\t\tfixed,"
                },
                {
                  "lineNumber": 117,
                  "content": "\t\tfixedContent: content,"
                },
                {
                  "lineNumber": 118,
                  "content": "\t\treordered: fixed ? countFunctionMovements(originalContent, content) : 0,"
                },
                {
                  "lineNumber": 136,
                  "content": "\treturn await fixFileWithErrorHandling({"
                },
                {
                  "lineNumber": 145,
                  "content": "\treturn createUnfixedResult(file, []);"
                },
                {
                  "lineNumber": 149,
                  "content": "\treturn createUnfixedResult(file, ["
                },
                {
                  "lineNumber": 150,
                  "content": "\t\t&#96;Cannot fix: ${count} circular dependencies detected. Refactoring required.&#96;,"
                },
                {
                  "lineNumber": 154,
                  "content": "async function fixFileWithErrorHandling(params: {"
                },
                {
                  "lineNumber": 161,
                  "content": "\t\treturn await fixFile(params);"
                },
                {
                  "lineNumber": 163,
                  "content": "\t\treturn createUnfixedResult(params.filePath, ["
                },
                {
                  "lineNumber": 169,
                  "content": "function createUnfixedResult(file: string, errors: string[] = []): FixResult {"
                },
                {
                  "lineNumber": 172,
                  "content": "\t\tfixed: false,"
                },
                {
                  "lineNumber": 174,
                  "content": "\t\tfixedContent: \"\","
                },
                {
                  "lineNumber": 180,
                  "content": "export async function fixFile(params: {"
                },
                {
                  "lineNumber": 188,
                  "content": "\tconst fixResult = fixParsedFile({ content: originalContent, filePath, config, analysisResult });"
                },
                {
                  "lineNumber": 190,
                  "content": "\tif (fixResult.fixed) {"
                },
                {
                  "lineNumber": 191,
                  "content": "\t\tawait service.writeFile(filePath, fixResult.fixedContent);"
                },
                {
                  "lineNumber": 194,
                  "content": "\treturn fixResult;"
                },
                {
                  "lineNumber": 197,
                  "content": "export function fixParsedFile(params: {"
                },
                {
                  "lineNumber": 206,
                  "content": "\tconst fixedContent = reorderFunctionDeclarations(sourceFile, analysisResult?.dependencyGraph);"
                },
                {
                  "lineNumber": 207,
                  "content": "\tconst hasChanges = fixedContent !== content;"
                },
                {
                  "lineNumber": 212,
                  "content": "\t\t\tfixed: true,"
                },
                {
                  "lineNumber": 214,
                  "content": "\t\t\tfixedContent,"
                },
                {
                  "lineNumber": 215,
                  "content": "\t\t\treordered: countFunctionMovements(content, fixedContent),"
                },
                {
                  "lineNumber": 222,
                  "content": "\t\tfixed: false,"
                },
                {
                  "lineNumber": 224,
                  "content": "\t\tfixedContent,"
                },
                {
                  "lineNumber": 614,
                  "content": "function countFunctionMovements(original: string, fixed: string): number {"
                },
                {
                  "lineNumber": 616,
                  "content": "\tconst fixedLines = fixed.split(\"\\n\");"
                },
                {
                  "lineNumber": 619,
                  "content": "\tfor (const [index, line] of fixedLines.entries()) {"
                }
              ]
            },
            {
              "file": "src/register-default-rules.ts",
              "matches": [
                {
                  "lineNumber": 3,
                  "content": "import { stepdownRule } from \"./stepdown-rule\";"
                },
                {
                  "lineNumber": 5,
                  "content": "register(stepdownRule);"
                }
              ]
            },
            {
              "file": "src/stepdown-rule.ts",
              "matches": [
                {
                  "lineNumber": 2,
                  "content": "import { reorderTopLevelOnly } from \"./fixer\";"
                },
                {
                  "lineNumber": 5,
                  "content": "export const stepdownRule = {"
                },
                {
                  "lineNumber": 6,
                  "content": "\tid: \"stepdown\","
                },
                {
                  "lineNumber": 10,
                  "content": "\tfix(ctx: RuleContext, _violations: Violation[]): string {"
                }
              ]
            },
            {
              "file": "src/cli.ts",
              "matches": [
                {
                  "lineNumber": 7,
                  "content": "import { fixFiles } from \"./fixer\";"
                },
                {
                  "lineNumber": 13,
                  "content": "\t.name(\"stepdown-rule\")"
                },
                {
                  "lineNumber": 14,
                  "content": "\t.description(\"TypeScript AST analyzer that enforces the stepdown rule for function organization\")"
                },
                {
                  "lineNumber": 17,
                  "content": "\t.option(\"--fix\", \"Automatically fix violations by reordering functions\", false)"
                },
                {
                  "lineNumber": 21,
                  "content": "\t.option(\"--config &lt;file&gt;\", \"Configuration file path\", \".stepdownrc.json\")"
                },
                {
                  "lineNumber": 27,
                  "content": "\t\t\tif (config.fix) {"
                },
                {
                  "lineNumber": 41,
                  "content": "\tfix?: boolean;"
                },
                {
                  "lineNumber": 59,
                  "content": "\t\tfix: options.fix ?? false,"
                },
                {
                  "lineNumber": 102,
                  "content": "\t\tconsole.log(picocolors.green(\"✓ No stepdown violations found\"));"
                },
                {
                  "lineNumber": 135,
                  "content": "\tconst fixResults = await fixFiles(getPatterns(patterns), config, fileService);"
                },
                {
                  "lineNumber": 136,
                  "content": "\toutputFixResults(fixResults, config.json);"
                },
                {
                  "lineNumber": 148,
                  "content": "\tconst changedFiles = results.filter((result) =&gt; result.fixed);"
                },
                {
                  "lineNumber": 153,
                  "content": "\t\tconsole.log(picocolors.green(\"✓ No files needed fixing\"));"
                },
                {
                  "lineNumber": 158,
                  "content": "\tif (result.fixed) {"
                }
              ]
            },
            {
              "file": "src/config/schema.ts",
              "matches": [
                {
                  "lineNumber": 19,
                  "content": "\tfix: [\"boolean\", \"=\", false],"
                },
                {
                  "lineNumber": 31,
                  "content": "\tanalyzeArrowFunctions: \"Whether to analyze arrow functions for stepdown violations\","
                },
                {
                  "lineNumber": 34,
                  "content": "\tfix: \"Whether to automatically fix stepdown violations\","
                }
              ]
            },
            {
              "file": "src/analyzer.ts",
              "matches": [
                {
                  "lineNumber": 78,
                  "content": "\tconst stepdownViolations = violations.filter(isStepdownViolation);"
                },
                {
                  "lineNumber": 85,
                  "content": "\t\tviolations: stepdownViolations,"
                }
              ]
            },
            {
              "file": "src/violation-coverage.ts",
              "matches": [
                {
                  "lineNumber": 2,
                  "content": " * uj1: Each analysis (violation type) must have a fix implementation."
                },
                {
                  "lineNumber": 3,
                  "content": " * When adding a new violation type to the analyzer, add it here and provide a fixture."
                },
                {
                  "lineNumber": 5,
                  "content": "export const ACTIONABLE_VIOLATION_TYPES = [\"stepdown\", \"nested\"] as const;"
                },
                {
                  "lineNumber": 10,
                  "content": "\tstepdown: &#96;function helper() { return \"h\"; }"
                }
              ]
            },
            {
              "file": "src/types.ts",
              "matches": [
                {
                  "lineNumber": 43,
                  "content": "\t/** Top-level function -&gt; callees (for fixer to use same view as analyzer) */"
                },
                {
                  "lineNumber": 49,
                  "content": "\tfixed: boolean;"
                },
                {
                  "lineNumber": 51,
                  "content": "\tfixedContent: string;"
                }
              ]
            },
            {
              "file": "src/index.ts",
              "matches": [
                {
                  "lineNumber": 2,
                  "content": "export * from \"./fixer\";"
                }
              ]
            }
          ],
          "totalLines": 86,
          "totalMatchedLines": 86
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "undefined" • **16** results in **1** directory</summary>

Directory: **/home/graff/WebstormProjects/stepdown-rule/src** (16 files)

| File |
|------|
| `rule-context.ts` |
| `nested-rule.ts` |
| `fixer.ts` |
| `register-default-rules.ts` |
| `stepdown-rule.ts` |
| `cli.ts` |
| `registry.ts` |
| `config/schema.ts` |
| `analyzer.ts` |
| `config/loader.ts` |
| `ast-utils.ts` |
| `services/FileService.ts` |
| `services/types.ts` |
| `violation-coverage.ts` |
| `types.ts` |
| `index.ts` |

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>

I see the flow now. The stepdown rule has a fix that uses `reorderTopLevelOnly` from the fixer. Let me read the stepdown-rule fix and the fixer's reorder logic to understand why moving `buildRuleContext` below `analyzeWithRules` wasn't applied.
</details></think>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /home/graff/WebstormProjects/stepdown-rule/src/stepdown-rule.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /home/graff/WebstormProjects/stepdown-rule/src/fixer.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: /home/graff/WebstormProjects/stepdown-rule/src/violation-coverage.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>

Now I need to understand how `reorderTopLevelOnly` / `reorderFunctions` works. The fix reorders based on `dependencyGraph`: caller should appear above callee. So if `analyzeWithRules` (line 61) calls `buildRuleContext` (line 38), the dependency graph has `analyzeWithRules -> buildRuleContext`. For stepdown compliance, callees should appear below callers, so `buildRuleContext` should be moved below `analyzeWithRules`. That means the topological order for "stepdown" would be: higher-level first (callers), then lower-level (callees). So we want: ... buildRuleContext ... analyzeWithRules ... wait no.

Stepdown rule: "high-level logic at top, details below". So a function that calls another should appear first (higher level), and the function it calls should appear later (lower level). So `analyzeWithRules` is higher level (it orchestrates), `buildRuleContext` is a detail. So we want:
1. analyzeWithRules (line 61)
2. buildRuleContext (line 38)

Currently we have buildRuleContext at 38, analyzeWithRules at 61. So we need to move buildRuleContext below analyzeWithRules. So the desired order is: ... analyzeWithRules ... buildRuleContext ...

The reorder logic: it takes dependency graph (caller -> callees). So analyzeWithRules -> [buildRuleContext, ...]. For stepdown we want caller above callee, so we need a topolog</details></think>

---

