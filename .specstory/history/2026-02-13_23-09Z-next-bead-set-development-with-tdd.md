<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 0ecfbe1d-342a-49c0-b9f4-21c40c64c947 (2026-02-13 23:09Z) -->

# Next bead set development with TDD (2026-02-13 23:09Z)

_**User**_

start work on the next bead set. use the tdd skill

---

_**Agent (model composer-1.5, mode Agent)**_





---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/.cursor/skills/tdd/SKILL.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/.cursor/skills/beads-bootstrap/SKILL.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/.cursor/skills/beads-orchestration/SKILL.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="semantic_search_full">
<details>
<summary>Tool use: **semantic_search_full**</summary>


Parameters:

```json
{
  "query": "What is a bead set and how is it structured?",
  "includePattern": "/home/graff/WebstormProjects/stepdown-rule",
  "topK": 10,
  "explanation": ""
}
```
Result:

```json
{
  "codeResults": [
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.beads/README.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 76
          }
        },
        "contents": "# Beads - AI-Native Issue Tracking\n\nWelcome to Beads! This repository uses **Beads** for issue tracking - a modern, AI-native tool designed to live directly in your codebase alongside your code.\n\n## What is Beads?\n\nBeads is issue tracking that lives in your repo, making it perfect for AI coding agents and developers who want their issues close to their code. No web UI required - everything works through the CLI and integrates seamlessly with git.\n\n**Learn more:** [github.com/steveyegge/beads](https://github.com/steveyegge/beads)\n\n## Quick Start\n\n### Essential Commands\n\n&#96;&#96;&#96;bash\n# Create new issues\nbd create \"Add user authentication\"\n\n# View all issues\nbd list\n\n# View issue details\nbd show &lt;issue-id&gt;\n\n# Update issue status\nbd update &lt;issue-id&gt; --status in_progress\nbd update &lt;issue-id&gt; --status done\n\n# Sync with git remote\nbd sync\n&#96;&#96;&#96;\n\n### Working with Issues\n\nIssues in Beads are:\n- **Git-native**: Stored in &#96;.beads/issues.jsonl&#96; and synced like code\n- **AI-friendly**: CLI-first design works perfectly with AI coding agents\n- **Branch-aware**: Issues can follow your branch workflow\n- **Always in sync**: Auto-syncs with your commits\n\n## Why Beads?\n\nâœ¨ **AI-Native Design**\n- Built specifically for AI-assisted development workflows\n- CLI-first interface works seamlessly with AI coding agents\n- No context switching to web UIs\n\nðŸš€ **Developer Focused**\n- Issues live in your repo, right next to your code\n- Works offline, syncs when you push\n- Fast, lightweight, and stays out of your way\n\nðŸ”§ **Git Integration**\n- Automatic sync with git commits\n- Branch-aware issue tracking\n- Intelligent JSONL merge resolution\n\n## Get Started with Beads\n\nTry Beads in your own projects:\n\n&#96;&#96;&#96;bash\n# Install Beads\ncurl -sSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash\n\n# Initialize in your repo\nbd init\n\n# Create your first issue\nbd create \"Try out Beads\"\n&#96;&#96;&#96;\n\n## Learn More\n\n- **Documentation**: [github.com/steveyegge/beads/docs](https://github.com/steveyegge/beads/tree/main/docs)\n- **Quick Start Guide**: Run &#96;bd quickstart&#96;",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# Beads - AI-Native Issue Tracking",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "Welcome to Beads! This repository uses **Beads** for issue tracking - a modern, AI-native tool designed to live directly in your codebase alongside your code.",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "## What is Beads?",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "Beads is issue tracking that lives in your repo, making it perfect for AI coding agents and developers who want their issues close to their code. No web UI required - everything works through the CLI and integrates seamlessly with git.",
            "lineNumber": 7
          },
          {
            "lineNumber": 8
          },
          {
            "text": "**Learn more:** [github.com/steveyegge/beads](https://github.com/steveyegge/beads)",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "## Quick Start",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "### Essential Commands",
            "lineNumber": 13
          },
          {
            "lineNumber": 14
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 15
          },
          {
            "text": "# Create new issues",
            "lineNumber": 16
          },
          {
            "text": "bd create \"Add user authentication\"",
            "lineNumber": 17
          },
          {
            "lineNumber": 18
          },
          {
            "text": "# View all issues",
            "lineNumber": 19
          },
          {
            "text": "bd list",
            "lineNumber": 20
          },
          {
            "lineNumber": 21
          },
          {
            "text": "# View issue details",
            "lineNumber": 22
          },
          {
            "text": "bd show &lt;issue-id&gt;",
            "lineNumber": 23
          },
          {
            "lineNumber": 24
          },
          {
            "text": "# Update issue status",
            "lineNumber": 25
          },
          {
            "text": "bd update &lt;issue-id&gt; --status in_progress",
            "lineNumber": 26
          },
          {
            "text": "bd update &lt;issue-id&gt; --status done",
            "lineNumber": 27
          },
          {
            "lineNumber": 28
          },
          {
            "text": "# Sync with git remote",
            "lineNumber": 29
          },
          {
            "text": "bd sync",
            "lineNumber": 30
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 31
          },
          {
            "lineNumber": 32
          },
          {
            "text": "### Working with Issues",
            "lineNumber": 33
          },
          {
            "lineNumber": 34
          },
          {
            "text": "Issues in Beads are:",
            "lineNumber": 35
          },
          {
            "text": "- **Git-native**: Stored in &#96;.beads/issues.jsonl&#96; and synced like code",
            "lineNumber": 36
          },
          {
            "text": "- **AI-friendly**: CLI-first design works perfectly with AI coding agents",
            "lineNumber": 37
          },
          {
            "text": "- **Branch-aware**: Issues can follow your branch workflow",
            "lineNumber": 38
          },
          {
            "text": "- **Always in sync**: Auto-syncs with your commits",
            "lineNumber": 39
          },
          {
            "lineNumber": 40
          },
          {
            "text": "## Why Beads?",
            "lineNumber": 41
          },
          {
            "lineNumber": 42
          },
          {
            "text": "âœ¨ **AI-Native Design**",
            "lineNumber": 43
          },
          {
            "text": "- Built specifically for AI-assisted development workflows",
            "lineNumber": 44
          },
          {
            "text": "- CLI-first interface works seamlessly with AI coding agents",
            "lineNumber": 45
          },
          {
            "text": "- No context switching to web UIs",
            "lineNumber": 46
          },
          {
            "lineNumber": 47
          },
          {
            "text": "ðŸš€ **Developer Focused**",
            "lineNumber": 48
          },
          {
            "text": "- Issues live in your repo, right next to your code",
            "lineNumber": 49
          },
          {
            "text": "- Works offline, syncs when you push",
            "lineNumber": 50
          },
          {
            "text": "- Fast, lightweight, and stays out of your way",
            "lineNumber": 51
          },
          {
            "lineNumber": 52
          },
          {
            "text": "ðŸ”§ **Git Integration**",
            "lineNumber": 53
          },
          {
            "text": "- Automatic sync with git commits",
            "lineNumber": 54
          },
          {
            "text": "- Branch-aware issue tracking",
            "lineNumber": 55
          },
          {
            "text": "- Intelligent JSONL merge resolution",
            "lineNumber": 56
          },
          {
            "lineNumber": 57
          },
          {
            "text": "## Get Started with Beads",
            "lineNumber": 58
          },
          {
            "lineNumber": 59
          },
          {
            "text": "Try Beads in your own projects:",
            "lineNumber": 60
          },
          {
            "lineNumber": 61
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 62
          },
          {
            "text": "# Install Beads",
            "lineNumber": 63
          },
          {
            "text": "curl -sSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash",
            "lineNumber": 64
          },
          {
            "lineNumber": 65
          },
          {
            "text": "# Initialize in your repo",
            "lineNumber": 66
          },
          {
            "text": "bd init",
            "lineNumber": 67
          },
          {
            "lineNumber": 68
          },
          {
            "text": "# Create your first issue",
            "lineNumber": 69
          },
          {
            "text": "bd create \"Try out Beads\"",
            "lineNumber": 70
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 71
          },
          {
            "lineNumber": 72
          },
          {
            "text": "## Learn More",
            "lineNumber": 73
          },
          {
            "lineNumber": 74
          },
          {
            "text": "- **Documentation**: [github.com/steveyegge/beads/docs](https://github.com/steveyegge/beads/tree/main/docs)",
            "lineNumber": 75
          },
          {
            "text": "- **Quick Start Guide**: Run &#96;bd quickstart&#96;",
            "lineNumber": 76
          }
        ]
      },
      "score": 0.3152182996273041
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.cursor/rules/beads.mdc",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 38
          }
        },
        "contents": "# Beads Issue Tracking\n# Auto-generated by 'bd setup cursor' - do not remove these markers\n# BEGIN BEADS INTEGRATION\n\nThis project uses [Beads (bd)](https://github.com/steveyegge/beads) for issue tracking.\n\n## Core Rules\n- Track ALL work in bd (never use markdown TODOs or comment-based task lists)\n- Use &#96;bd ready&#96; to find available work\n- Use &#96;bd create&#96; to track new issues/tasks/bugs\n- Use &#96;bd sync&#96; at end of session to sync with git remote\n- Git hooks auto-sync on commit/merge\n\n## Quick Reference\n&#96;&#96;&#96;bash\nbd prime                              # Load complete workflow context\nbd ready                              # Show issues ready to work (no blockers)\nbd list --status=open                 # List all open issues\nbd create --title=\"...\" --type=task  # Create new issue\nbd update &lt;id&gt; --status=in_progress  # Claim work\nbd close &lt;id&gt;                         # Mark complete\nbd dep add &lt;issue&gt; &lt;depends-on&gt;       # Add dependency (issue depends on depends-on)\nbd sync                               # Sync with git remote\n&#96;&#96;&#96;\n\n## Workflow\n1. Check for ready work: &#96;bd ready&#96;\n2. Claim an issue: &#96;bd update &lt;id&gt; --status=in_progress&#96;\n3. Do the work\n4. Mark complete: &#96;bd close &lt;id&gt;&#96;\n5. Sync: &#96;bd sync&#96; (or let git hooks handle it)\n\n## Context Loading\nRun &#96;bd prime&#96; to get complete workflow documentation in AI-optimized format (~1-2k tokens).\n\nFor detailed docs: see AGENTS.md, QUICKSTART.md, or run &#96;bd --help&#96;\n\n# END BEADS INTEGRATION",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# Beads Issue Tracking",
            "lineNumber": 1
          },
          {
            "text": "# Auto-generated by 'bd setup cursor' - do not remove these markers",
            "lineNumber": 2
          },
          {
            "text": "# BEGIN BEADS INTEGRATION",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "This project uses [Beads (bd)](https://github.com/steveyegge/beads) for issue tracking.",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "## Core Rules",
            "lineNumber": 7
          },
          {
            "text": "- Track ALL work in bd (never use markdown TODOs or comment-based task lists)",
            "lineNumber": 8
          },
          {
            "text": "- Use &#96;bd ready&#96; to find available work",
            "lineNumber": 9
          },
          {
            "text": "- Use &#96;bd create&#96; to track new issues/tasks/bugs",
            "lineNumber": 10
          },
          {
            "text": "- Use &#96;bd sync&#96; at end of session to sync with git remote",
            "lineNumber": 11
          },
          {
            "text": "- Git hooks auto-sync on commit/merge",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "## Quick Reference",
            "lineNumber": 14
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 15
          },
          {
            "text": "bd prime                              # Load complete workflow context",
            "lineNumber": 16
          },
          {
            "text": "bd ready                              # Show issues ready to work (no blockers)",
            "lineNumber": 17
          },
          {
            "text": "bd list --status=open                 # List all open issues",
            "lineNumber": 18
          },
          {
            "text": "bd create --title=\"...\" --type=task  # Create new issue",
            "lineNumber": 19
          },
          {
            "text": "bd update &lt;id&gt; --status=in_progress  # Claim work",
            "lineNumber": 20
          },
          {
            "text": "bd close &lt;id&gt;                         # Mark complete",
            "lineNumber": 21
          },
          {
            "text": "bd dep add &lt;issue&gt; &lt;depends-on&gt;       # Add dependency (issue depends on depends-on)",
            "lineNumber": 22
          },
          {
            "text": "bd sync                               # Sync with git remote",
            "lineNumber": 23
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 24
          },
          {
            "lineNumber": 25
          },
          {
            "text": "## Workflow",
            "lineNumber": 26
          },
          {
            "text": "1. Check for ready work: &#96;bd ready&#96;",
            "lineNumber": 27
          },
          {
            "text": "2. Claim an issue: &#96;bd update &lt;id&gt; --status=in_progress&#96;",
            "lineNumber": 28
          },
          {
            "text": "3. Do the work",
            "lineNumber": 29
          },
          {
            "text": "4. Mark complete: &#96;bd close &lt;id&gt;&#96;",
            "lineNumber": 30
          },
          {
            "text": "5. Sync: &#96;bd sync&#96; (or let git hooks handle it)",
            "lineNumber": 31
          },
          {
            "lineNumber": 32
          },
          {
            "text": "## Context Loading",
            "lineNumber": 33
          },
          {
            "text": "Run &#96;bd prime&#96; to get complete workflow documentation in AI-optimized format (~1-2k tokens).",
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "For detailed docs: see AGENTS.md, QUICKSTART.md, or run &#96;bd --help&#96;",
            "lineNumber": 36
          },
          {
            "lineNumber": 37
          },
          {
            "text": "# END BEADS INTEGRATION",
            "lineNumber": 38
          }
        ]
      },
      "score": 0.26033514738082886
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.beads/config.yaml",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 55
          }
        },
        "contents": "# Beads Configuration File\n# This file configures default behavior for all bd commands in this repository\n# All settings can also be set via environment variables (BD_* prefix)\n# or overridden with command-line flags\n\n# Issue prefix for this repository (used by bd init)\n# If not set, bd init will auto-detect from directory name\n# Example: issue-prefix: \"myproject\" creates issues like \"myproject-1\", \"myproject-2\", etc.\n# issue-prefix: \"\"\n\n# Use no-db mode: load from JSONL, no SQLite, write back after each command\n# When true, bd will use .beads/issues.jsonl as the source of truth\n# instead of SQLite database\n# no-db: false\n\n# Disable daemon for RPC communication (forces direct database access)\n# no-daemon: false\n\n# Disable auto-flush of database to JSONL after mutations\n# no-auto-flush: false\n\n# Disable auto-import from JSONL when it's newer than database\n# no-auto-import: false\n\n# Enable JSON output by default\n# json: false\n\n# Default actor for audit trails (overridden by BD_ACTOR or --actor)\n# actor: \"\"\n\n# Path to database (overridden by BEADS_DB or --db)\n# db: \"\"\n\n# Auto-start daemon if not running (can also use BEADS_AUTO_START_DAEMON)\n# auto-start-daemon: true\n\n# Debounce interval for auto-flush (can also use BEADS_FLUSH_DEBOUNCE)\n# flush-debounce: \"5s\"\n\n# Export events (audit trail) to .beads/events.jsonl on each flush/sync\n# When enabled, new events are appended incrementally using a high-water mark.\n# Use 'bd export --events' to trigger manually regardless of this setting.\n# events-export: false\n\n# Git branch for beads commits (bd sync will commit to this branch)\n# IMPORTANT: Set this for team projects so all clones use the same sync branch.\n# This setting persists across clones (unlike database config which is gitignored).\n# Can also use BEADS_SYNC_BRANCH env var for local override.\n# If not set, bd sync will require you to run 'bd config set sync.branch &lt;branch&gt;'.\n# sync-branch: \"beads-sync\"\n\n# Multi-repo configuration (experimental - bd-307)\n# Allows hydrating from multiple repositories and routing writes to the correct JSONL\n# repos:\n#   primary: \".\"  # Primary repo (where this database lives)",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# Beads Configuration File",
            "lineNumber": 1
          },
          {
            "text": "# This file configures default behavior for all bd commands in this repository",
            "lineNumber": 2
          },
          {
            "text": "# All settings can also be set via environment variables (BD_* prefix)",
            "lineNumber": 3
          },
          {
            "text": "# or overridden with command-line flags",
            "lineNumber": 4
          },
          {
            "lineNumber": 5
          },
          {
            "text": "# Issue prefix for this repository (used by bd init)",
            "lineNumber": 6
          },
          {
            "text": "# If not set, bd init will auto-detect from directory name",
            "lineNumber": 7
          },
          {
            "text": "# Example: issue-prefix: \"myproject\" creates issues like \"myproject-1\", \"myproject-2\", etc.",
            "lineNumber": 8
          },
          {
            "text": "# issue-prefix: \"\"",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "# Use no-db mode: load from JSONL, no SQLite, write back after each command",
            "lineNumber": 11
          },
          {
            "text": "# When true, bd will use .beads/issues.jsonl as the source of truth",
            "lineNumber": 12
          },
          {
            "text": "# instead of SQLite database",
            "lineNumber": 13
          },
          {
            "text": "# no-db: false",
            "lineNumber": 14
          },
          {
            "lineNumber": 15
          },
          {
            "text": "# Disable daemon for RPC communication (forces direct database access)",
            "lineNumber": 16
          },
          {
            "text": "# no-daemon: false",
            "lineNumber": 17
          },
          {
            "lineNumber": 18
          },
          {
            "text": "# Disable auto-flush of database to JSONL after mutations",
            "lineNumber": 19
          },
          {
            "text": "# no-auto-flush: false",
            "lineNumber": 20
          },
          {
            "lineNumber": 21
          },
          {
            "text": "# Disable auto-import from JSONL when it's newer than database",
            "lineNumber": 22
          },
          {
            "text": "# no-auto-import: false",
            "lineNumber": 23
          },
          {
            "lineNumber": 24
          },
          {
            "text": "# Enable JSON output by default",
            "lineNumber": 25
          },
          {
            "text": "# json: false",
            "lineNumber": 26
          },
          {
            "lineNumber": 27
          },
          {
            "text": "# Default actor for audit trails (overridden by BD_ACTOR or --actor)",
            "lineNumber": 28
          },
          {
            "text": "# actor: \"\"",
            "lineNumber": 29
          },
          {
            "lineNumber": 30
          },
          {
            "text": "# Path to database (overridden by BEADS_DB or --db)",
            "lineNumber": 31
          },
          {
            "text": "# db: \"\"",
            "lineNumber": 32
          },
          {
            "lineNumber": 33
          },
          {
            "text": "# Auto-start daemon if not running (can also use BEADS_AUTO_START_DAEMON)",
            "lineNumber": 34
          },
          {
            "text": "# auto-start-daemon: true",
            "lineNumber": 35
          },
          {
            "lineNumber": 36
          },
          {
            "text": "# Debounce interval for auto-flush (can also use BEADS_FLUSH_DEBOUNCE)",
            "lineNumber": 37
          },
          {
            "text": "# flush-debounce: \"5s\"",
            "lineNumber": 38
          },
          {
            "lineNumber": 39
          },
          {
            "text": "# Export events (audit trail) to .beads/events.jsonl on each flush/sync",
            "lineNumber": 40
          },
          {
            "text": "# When enabled, new events are appended incrementally using a high-water mark.",
            "lineNumber": 41
          },
          {
            "text": "# Use 'bd export --events' to trigger manually regardless of this setting.",
            "lineNumber": 42
          },
          {
            "text": "# events-export: false",
            "lineNumber": 43
          },
          {
            "lineNumber": 44
          },
          {
            "text": "# Git branch for beads commits (bd sync will commit to this branch)",
            "lineNumber": 45
          },
          {
            "text": "# IMPORTANT: Set this for team projects so all clones use the same sync branch.",
            "lineNumber": 46
          },
          {
            "text": "# This setting persists across clones (unlike database config which is gitignored).",
            "lineNumber": 47
          },
          {
            "text": "# Can also use BEADS_SYNC_BRANCH env var for local override.",
            "lineNumber": 48
          },
          {
            "text": "# If not set, bd sync will require you to run 'bd config set sync.branch &lt;branch&gt;'.",
            "lineNumber": 49
          },
          {
            "text": "# sync-branch: \"beads-sync\"",
            "lineNumber": 50
          },
          {
            "lineNumber": 51
          },
          {
            "text": "# Multi-repo configuration (experimental - bd-307)",
            "lineNumber": 52
          },
          {
            "text": "# Allows hydrating from multiple repositories and routing writes to the correct JSONL",
            "lineNumber": 53
          },
          {
            "text": "# repos:",
            "lineNumber": 54
          },
          {
            "text": "#   primary: \".\"  # Primary repo (where this database lives)",
            "lineNumber": 55
          }
        ]
      },
      "score": 0.260206937789917
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.beads/metadata.json",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 4
          }
        },
        "contents": "{\n\t\"database\": \"beads.db\",\n\t\"jsonl_export\": \"issues.jsonl\"\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "{",
            "lineNumber": 1
          },
          {
            "text": "\t\"database\": \"beads.db\",",
            "lineNumber": 2
          },
          {
            "text": "\t\"jsonl_export\": \"issues.jsonl\"",
            "lineNumber": 3
          },
          {
            "text": "}",
            "lineNumber": 4
          }
        ]
      },
      "score": 0.25509199500083923
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.beads/subagent-assignments.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 29
          }
        },
        "contents": "# Subagent Assignments - Bug Beads\n\nAssignments for parallel subagent execution. Each subagent MUST:\n1. Load &#96;subagent-workflow&#96; skill\n2. Use &#96;bd update &lt;bead-id&gt; --status in_progress&#96; at start\n3. Run &#96;bun run vet&#96; and &#96;bun test&#96; before completion\n4. Use &#96;bd close &lt;bead-id&gt; --reason \"Completed\"&#96; on success, or escalate\n\n---\n\n## P0 Bugs (Critical)\n\n### stepdown-rule-1e0 - Fixer2: Dependency graph incompleteness\n- **Category**: &#96;coding&#96;\n- **Skills**: &#96;subagent-workflow&#96;\n- **Prompt**:\n  Fix the fixer's dependency graph in &#96;src/fixer.ts&#96;. &#96;buildDependencyGraph&#96; (lines 204-221) and &#96;extractDependenciesFor&#96; (line 229) do not capture all function relationships. Evidence: cart-composition.ts reports 'reordered 0 functions' yet &#96;composeCartDomain&#96; calls &#96;sessionStoreToRepository&#96;. The dependency extraction may miss call sites in factory functions that return objects with methods. Add recursive traversal or handle factory-return patterns so all callees are found. Run stepdown-rule on ff-elysia (or fixtures) to verify more violations get fixed.\n- **Acceptance**: &#96;extractDependenciesFor&#96; finds deps inside returned object literals; cart-composition violations reduce.\n\n### stepdown-rule-27g - Fixer1: Arrow functions in const declarations not properly reordered\n- **Category**: &#96;coding&#96;\n- **Skills**: &#96;subagent-workflow&#96;\n- **Prompt**:\n  Fix arrow function ordering in &#96;src/fixer.ts&#96;. Arrow functions like &#96;const mapValidOrders = (...) =&gt; ...&#96; are categorized but topological sort doesn't handle them correctly. Example: order-repository.ts has mapValidOrders (line 118) calling validateAndParseOrder (line 106) - violation persists. Ensure &#96;categorizeVariableStatement&#96; and &#96;reorderFunctions&#96; treat const-assigned arrow functions as reorderable, and topo sort places callees below callers per stepdown rule.\n- **Acceptance**: order-repository.ts and wishlist-repository.ts violations in ff-elysia fix without creating new ones.\n\n### stepdown-rule-96h - Fixer3: Reordering creates new violations (global opt)\n- **Category**: &#96;coding&#96;\n- **Skills**: &#96;subagent-workflow&#96;",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# Subagent Assignments - Bug Beads",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "Assignments for parallel subagent execution. Each subagent MUST:",
            "lineNumber": 3
          },
          {
            "text": "1. Load &#96;subagent-workflow&#96; skill",
            "lineNumber": 4
          },
          {
            "text": "2. Use &#96;bd update &lt;bead-id&gt; --status in_progress&#96; at start",
            "lineNumber": 5
          },
          {
            "text": "3. Run &#96;bun run vet&#96; and &#96;bun test&#96; before completion",
            "lineNumber": 6
          },
          {
            "text": "4. Use &#96;bd close &lt;bead-id&gt; --reason \"Completed\"&#96; on success, or escalate",
            "lineNumber": 7
          },
          {
            "lineNumber": 8
          },
          {
            "text": "---",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "## P0 Bugs (Critical)",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "### stepdown-rule-1e0 - Fixer2: Dependency graph incompleteness",
            "lineNumber": 13
          },
          {
            "text": "- **Category**: &#96;coding&#96;",
            "lineNumber": 14
          },
          {
            "text": "- **Skills**: &#96;subagent-workflow&#96;",
            "lineNumber": 15
          },
          {
            "text": "- **Prompt**:",
            "lineNumber": 16
          },
          {
            "text": "  Fix the fixer's dependency graph in &#96;src/fixer.ts&#96;. &#96;buildDependencyGraph&#96; (lines 204-221) and &#96;extractDependenciesFor&#96; (line 229) do not capture all function relationships. Evidence: cart-composition.ts reports 'reordered 0 functions' yet &#96;composeCartDomain&#96; calls &#96;sessionStoreToRepository&#96;. The dependency extraction may miss call sites in factory functions that return objects with methods. Add recursive traversal or handle factory-return patterns so all callees are found. Run stepdown-rule on ff-elysia (or fixtures) to verify more violations get fixed.",
            "lineNumber": 17
          },
          {
            "text": "- **Acceptance**: &#96;extractDependenciesFor&#96; finds deps inside returned object literals; cart-composition violations reduce.",
            "lineNumber": 18
          },
          {
            "lineNumber": 19
          },
          {
            "text": "### stepdown-rule-27g - Fixer1: Arrow functions in const declarations not properly reordered",
            "lineNumber": 20
          },
          {
            "text": "- **Category**: &#96;coding&#96;",
            "lineNumber": 21
          },
          {
            "text": "- **Skills**: &#96;subagent-workflow&#96;",
            "lineNumber": 22
          },
          {
            "text": "- **Prompt**:",
            "lineNumber": 23
          },
          {
            "text": "  Fix arrow function ordering in &#96;src/fixer.ts&#96;. Arrow functions like &#96;const mapValidOrders = (...) =&gt; ...&#96; are categorized but topological sort doesn't handle them correctly. Example: order-repository.ts has mapValidOrders (line 118) calling validateAndParseOrder (line 106) - violation persists. Ensure &#96;categorizeVariableStatement&#96; and &#96;reorderFunctions&#96; treat const-assigned arrow functions as reorderable, and topo sort places callees below callers per stepdown rule.",
            "lineNumber": 24
          },
          {
            "text": "- **Acceptance**: order-repository.ts and wishlist-repository.ts violations in ff-elysia fix without creating new ones.",
            "lineNumber": 25
          },
          {
            "lineNumber": 26
          },
          {
            "text": "### stepdown-rule-96h - Fixer3: Reordering creates new violations (global opt)",
            "lineNumber": 27
          },
          {
            "text": "- **Category**: &#96;coding&#96;",
            "lineNumber": 28
          },
          {
            "text": "- **Skills**: &#96;subagent-workflow&#96;",
            "lineNumber": 29
          }
        ]
      },
      "score": 0.2201969027519226
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.beads/README.md",
        "range": {
          "startPosition": {
            "line": 74
          },
          "endPosition": {
            "line": 81
          }
        },
        "contents": "- **Documentation**: [github.com/steveyegge/beads/docs](https://github.com/steveyegge/beads/tree/main/docs)\n- **Quick Start Guide**: Run &#96;bd quickstart&#96;\n- **Examples**: [github.com/steveyegge/beads/examples](https://github.com/steveyegge/beads/tree/main/examples)\n\n---\n\n*Beads: Issue tracking that moves at the speed of thought* âš¡",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- **Documentation**: [github.com/steveyegge/beads/docs](https://github.com/steveyegge/beads/tree/main/docs)",
            "lineNumber": 75
          },
          {
            "text": "- **Quick Start Guide**: Run &#96;bd quickstart&#96;",
            "lineNumber": 76
          },
          {
            "text": "- **Examples**: [github.com/steveyegge/beads/examples](https://github.com/steveyegge/beads/tree/main/examples)",
            "lineNumber": 77
          },
          {
            "lineNumber": 78
          },
          {
            "text": "---",
            "lineNumber": 79
          },
          {
            "lineNumber": 80
          },
          {
            "text": "*Beads: Issue tracking that moves at the speed of thought* âš¡",
            "lineNumber": 81
          }
        ]
      },
      "score": 0.2118217945098877
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.beads/config.yaml",
        "range": {
          "startPosition": {
            "line": 52
          },
          "endPosition": {
            "line": 67
          }
        },
        "contents": "# Allows hydrating from multiple repositories and routing writes to the correct JSONL\n# repos:\n#   primary: \".\"  # Primary repo (where this database lives)\n#   additional:   # Additional repos to hydrate from (read-only)\n#     - ~/beads-planning  # Personal planning repo\n#     - ~/work-planning   # Work planning repo\n\n# Integration settings (access with 'bd config get/set')\n# These are stored in the database, not in this file:\n# - jira.url\n# - jira.project\n# - linear.url\n# - linear.api-key\n# - github.org\n# - github.repo",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# Allows hydrating from multiple repositories and routing writes to the correct JSONL",
            "lineNumber": 53
          },
          {
            "text": "# repos:",
            "lineNumber": 54
          },
          {
            "text": "#   primary: \".\"  # Primary repo (where this database lives)",
            "lineNumber": 55
          },
          {
            "text": "#   additional:   # Additional repos to hydrate from (read-only)",
            "lineNumber": 56
          },
          {
            "text": "#     - ~/beads-planning  # Personal planning repo",
            "lineNumber": 57
          },
          {
            "text": "#     - ~/work-planning   # Work planning repo",
            "lineNumber": 58
          },
          {
            "lineNumber": 59
          },
          {
            "text": "# Integration settings (access with 'bd config get/set')",
            "lineNumber": 60
          },
          {
            "text": "# These are stored in the database, not in this file:",
            "lineNumber": 61
          },
          {
            "text": "# - jira.url",
            "lineNumber": 62
          },
          {
            "text": "# - jira.project",
            "lineNumber": 63
          },
          {
            "text": "# - linear.url",
            "lineNumber": 64
          },
          {
            "text": "# - linear.api-key",
            "lineNumber": 65
          },
          {
            "text": "# - github.org",
            "lineNumber": 66
          },
          {
            "text": "# - github.repo",
            "lineNumber": 67
          }
        ]
      },
      "score": 0.20420336723327637
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.changeset/beads-task-tracking.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 8
          }
        },
        "contents": "---\n\"@stepdown/analyzer\": patch\n---\n\nAdd beads task tracking workflow\n\n- Add .beads directory with configuration for task tracking\n- Add .gitattributes for consistent git behavior",
        "signatures": {},
        "detailedLines": [
          {
            "text": "---",
            "lineNumber": 1
          },
          {
            "text": "\"@stepdown/analyzer\": patch",
            "lineNumber": 2
          },
          {
            "text": "---",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "Add beads task tracking workflow",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "- Add .beads directory with configuration for task tracking",
            "lineNumber": 7
          },
          {
            "text": "- Add .gitattributes for consistent git behavior",
            "lineNumber": 8
          }
        ]
      },
      "score": 0.19345033168792725
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.gitattributes",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 3
          }
        },
        "contents": "# Use bd merge for beads JSONL files\n.beads/issues.jsonl merge=beads",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# Use bd merge for beads JSONL files",
            "lineNumber": 2
          },
          {
            "text": ".beads/issues.jsonl merge=beads",
            "lineNumber": 3
          }
        ]
      },
      "score": 0.18867546319961548
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.beads/22-violations-analysis.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 40
          }
        },
        "contents": "# 22 Persistent Violations - Failure Mode Taxonomy\n\nAnalysis of violations that remain after &#96;stepdown-rule --fix&#96; in ff-elysia.\n\n## Failure Mode Mapping\n\n| FM | Description | Affected Files | Bead |\n|----|-------------|----------------|------|\n| **FM1** | Nested functions inside callback (fixer never sees them) | session.ts | stepdown-rule-db8 (Fixer5), stepdown-rule-aka (Fixer7) |\n| **FM2** | Arrow functions in const - topo sort chain breaks | order-repository, wishlist-repository | stepdown-rule-27g (Fixer1) |\n| **FM3** | Fix creates new violations - ping-pong, no convergence | cart-composition, container | stepdown-rule-96h (Fixer3), stepdown-rule-0om (Fixer6) |\n| **FM4** | Dep graph misses deps or analyzer/fixer diverge | cart, container, order-repo | stepdown-rule-1e0 (Fixer2), stepdown-rule-hje (Fixer8) |\n| **FM5** | Mutual dep pairs - fix one creates other | product-handlers | stepdown-rule-96h |\n\n**Master reference:** stepdown-rule-aad\n\n## Violation Detail by File\n\n### src/plugins/session.ts (FM1)\n- ensureSessionCookie calls getSessionId - both inside &#96;.derive()&#96; callback\n- Fixer: categorizeNodes only iterates sourceFile direct children; these are inside sessionPlugin initializer\n\n### src/di/cart-composition.ts (FM3/FM4)\n- composeCartDomain calls createCartPresenter, createCartUseCase, createCartController\n- After fix: composeCartDomain calls sessionStoreToRepository (violation flips)\n- Fixer reordered 1 function; ping-pong between violation sets\n\n### src/di/container.ts (FM3/FM4)\n- createMockServices calls createServices\n- Multi-level DI: createServicesâ†’createSurrealServicesâ†’createSurrealRepositories\n- Fix reordered 3 but violations persist or reappear as different set\n\n### src/handlers/product-handlers.ts (FM5)\n- createProduct calls generateSlug / removeProduct calls findProductIndex\n- Fix reorders 1; next run shows the other pair violated\n- Mutual pairs - resolving one exposes the other\n\n### src/infrastructure/surreal/order-repository.ts (FM2/FM4)\n- createSurrealOrderRepository (factory) calls: generateOrderId, calculateOrderTotal, parseSingleOrder, mapValidOrders\n- mapValidOrders, parseSingleOrder call validateAndParseOrder (arrow chain)",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# 22 Persistent Violations - Failure Mode Taxonomy",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "Analysis of violations that remain after &#96;stepdown-rule --fix&#96; in ff-elysia.",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "## Failure Mode Mapping",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "| FM | Description | Affected Files | Bead |",
            "lineNumber": 7
          },
          {
            "text": "|----|-------------|----------------|------|",
            "lineNumber": 8
          },
          {
            "text": "| **FM1** | Nested functions inside callback (fixer never sees them) | session.ts | stepdown-rule-db8 (Fixer5), stepdown-rule-aka (Fixer7) |",
            "lineNumber": 9
          },
          {
            "text": "| **FM2** | Arrow functions in const - topo sort chain breaks | order-repository, wishlist-repository | stepdown-rule-27g (Fixer1) |",
            "lineNumber": 10
          },
          {
            "text": "| **FM3** | Fix creates new violations - ping-pong, no convergence | cart-composition, container | stepdown-rule-96h (Fixer3), stepdown-rule-0om (Fixer6) |",
            "lineNumber": 11
          },
          {
            "text": "| **FM4** | Dep graph misses deps or analyzer/fixer diverge | cart, container, order-repo | stepdown-rule-1e0 (Fixer2), stepdown-rule-hje (Fixer8) |",
            "lineNumber": 12
          },
          {
            "text": "| **FM5** | Mutual dep pairs - fix one creates other | product-handlers | stepdown-rule-96h |",
            "lineNumber": 13
          },
          {
            "lineNumber": 14
          },
          {
            "text": "**Master reference:** stepdown-rule-aad",
            "lineNumber": 15
          },
          {
            "lineNumber": 16
          },
          {
            "text": "## Violation Detail by File",
            "lineNumber": 17
          },
          {
            "lineNumber": 18
          },
          {
            "text": "### src/plugins/session.ts (FM1)",
            "lineNumber": 19
          },
          {
            "text": "- ensureSessionCookie calls getSessionId - both inside &#96;.derive()&#96; callback",
            "lineNumber": 20
          },
          {
            "text": "- Fixer: categorizeNodes only iterates sourceFile direct children; these are inside sessionPlugin initializer",
            "lineNumber": 21
          },
          {
            "lineNumber": 22
          },
          {
            "text": "### src/di/cart-composition.ts (FM3/FM4)",
            "lineNumber": 23
          },
          {
            "text": "- composeCartDomain calls createCartPresenter, createCartUseCase, createCartController",
            "lineNumber": 24
          },
          {
            "text": "- After fix: composeCartDomain calls sessionStoreToRepository (violation flips)",
            "lineNumber": 25
          },
          {
            "text": "- Fixer reordered 1 function; ping-pong between violation sets",
            "lineNumber": 26
          },
          {
            "lineNumber": 27
          },
          {
            "text": "### src/di/container.ts (FM3/FM4)",
            "lineNumber": 28
          },
          {
            "text": "- createMockServices calls createServices",
            "lineNumber": 29
          },
          {
            "text": "- Multi-level DI: createServicesâ†’createSurrealServicesâ†’createSurrealRepositories",
            "lineNumber": 30
          },
          {
            "text": "- Fix reordered 3 but violations persist or reappear as different set",
            "lineNumber": 31
          },
          {
            "lineNumber": 32
          },
          {
            "text": "### src/handlers/product-handlers.ts (FM5)",
            "lineNumber": 33
          },
          {
            "text": "- createProduct calls generateSlug / removeProduct calls findProductIndex",
            "lineNumber": 34
          },
          {
            "text": "- Fix reorders 1; next run shows the other pair violated",
            "lineNumber": 35
          },
          {
            "text": "- Mutual pairs - resolving one exposes the other",
            "lineNumber": 36
          },
          {
            "lineNumber": 37
          },
          {
            "text": "### src/infrastructure/surreal/order-repository.ts (FM2/FM4)",
            "lineNumber": 38
          },
          {
            "text": "- createSurrealOrderRepository (factory) calls: generateOrderId, calculateOrderTotal, parseSingleOrder, mapValidOrders",
            "lineNumber": 39
          },
          {
            "text": "- mapValidOrders, parseSingleOrder call validateAndParseOrder (arrow chain)",
            "lineNumber": 40
          }
        ]
      },
      "score": 0.17162376642227173
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.beads/subagent-assignments.md",
        "range": {
          "startPosition": {
            "line": 50
          },
          "endPosition": {
            "line": 76
          }
        },
        "contents": "### stepdown-rule-aka - Fixer7: Fixer only processes sourceFile direct children â€” DONE\n- **Completed**: transformNestedBlocks reorders functions inside ArrowFunction/FunctionExpression/FunctionDeclaration bodies\n\n### stepdown-rule-db8 - Fixer5: Nested/inline functions inside .derive() blocks â€” DONE\n- **Completed**: analyzer already descends into call args; fixer (aka) reorders nested blocks. Tests added.\n\n### stepdown-rule-obe - Fixer4: Exported vs non-exported variable functions inconsistent â€” DONE\n- **Completed**: removed hasExportModifier filter in extractFunctions, set isExported in createVariableFunctionInfo\n\n### stepdown-rule-77q - Fix idempotency in ff-elysia tool\n- **Category**: &#96;coding&#96;\n- **Skills**: &#96;subagent-workflow&#96;\n- **Prompt**:\n  stepdown-rule run on ff-elysia is not idempotent. See ff-elysia-output.md. Requires cloning/running in ff-elysia project. Likely downstream of 0om/96h - if fixâ†’analyze converges here, this may resolve. If 0om fixed, verify in ff-elysia; else document as blocked.\n- **Acceptance**: stepdown-rule on ff-elysia converges (same output on repeated runs).\n\n---\n\n## Reference (no assignment)\n\n### stepdown-rule-aad\nMaster taxonomy. Close when child beads (1e0, 27g, 96h, db8, aka, hje, 0om, obe) are resolved.\n\n### stepdown-rule-uj1\nFeature bead (P2). Defer.",
        "signatures": {},
        "detailedLines": [
          {
            "text": "### stepdown-rule-aka - Fixer7: Fixer only processes sourceFile direct children â€” DONE",
            "lineNumber": 52
          },
          {
            "text": "- **Completed**: transformNestedBlocks reorders functions inside ArrowFunction/FunctionExpression/FunctionDeclaration bodies",
            "lineNumber": 53
          },
          {
            "lineNumber": 54
          },
          {
            "text": "### stepdown-rule-db8 - Fixer5: Nested/inline functions inside .derive() blocks â€” DONE",
            "lineNumber": 55
          },
          {
            "text": "- **Completed**: analyzer already descends into call args; fixer (aka) reorders nested blocks. Tests added.",
            "lineNumber": 56
          },
          {
            "lineNumber": 57
          },
          {
            "text": "### stepdown-rule-obe - Fixer4: Exported vs non-exported variable functions inconsistent â€” DONE",
            "lineNumber": 58
          },
          {
            "text": "- **Completed**: removed hasExportModifier filter in extractFunctions, set isExported in createVariableFunctionInfo",
            "lineNumber": 59
          },
          {
            "lineNumber": 60
          },
          {
            "text": "### stepdown-rule-77q - Fix idempotency in ff-elysia tool",
            "lineNumber": 61
          },
          {
            "text": "- **Category**: &#96;coding&#96;",
            "lineNumber": 62
          },
          {
            "text": "- **Skills**: &#96;subagent-workflow&#96;",
            "lineNumber": 63
          },
          {
            "text": "- **Prompt**:",
            "lineNumber": 64
          },
          {
            "text": "  stepdown-rule run on ff-elysia is not idempotent. See ff-elysia-output.md. Requires cloning/running in ff-elysia project. Likely downstream of 0om/96h - if fixâ†’analyze converges here, this may resolve. If 0om fixed, verify in ff-elysia; else document as blocked.",
            "lineNumber": 65
          },
          {
            "text": "- **Acceptance**: stepdown-rule on ff-elysia converges (same output on repeated runs).",
            "lineNumber": 66
          },
          {
            "lineNumber": 67
          },
          {
            "text": "---",
            "lineNumber": 68
          },
          {
            "lineNumber": 69
          },
          {
            "text": "## Reference (no assignment)",
            "lineNumber": 70
          },
          {
            "lineNumber": 71
          },
          {
            "text": "### stepdown-rule-aad",
            "lineNumber": 72
          },
          {
            "text": "Master taxonomy. Close when child beads (1e0, 27g, 96h, db8, aka, hje, 0om, obe) are resolved.",
            "lineNumber": 73
          },
          {
            "lineNumber": 74
          },
          {
            "text": "### stepdown-rule-uj1",
            "lineNumber": 75
          },
          {
            "text": "Feature bead (P2). Defer.",
            "lineNumber": 76
          }
        ]
      },
      "score": 0.168196901679039
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.sisyphus/boulder.json",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 7
          }
        },
        "contents": "{\n\t\"active_plan\": \"/home/graff/WebstormProjects/stepdown-rule/.sisyphus/plans/decouple-file-io.md\",\n\t\"started_at\": \"2026-02-13T22:11:50.187Z\",\n\t\"session_ids\": [\"ses_3a6f94db6ffexbe6xFp2zGQ2pv\"],\n\t\"plan_name\": \"decouple-file-io\",\n\t\"agent\": \"atlas\"\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "{",
            "lineNumber": 1
          },
          {
            "text": "\t\"active_plan\": \"/home/graff/WebstormProjects/stepdown-rule/.sisyphus/plans/decouple-file-io.md\",",
            "lineNumber": 2
          },
          {
            "text": "\t\"started_at\": \"2026-02-13T22:11:50.187Z\",",
            "lineNumber": 3
          },
          {
            "text": "\t\"session_ids\": [\"ses_3a6f94db6ffexbe6xFp2zGQ2pv\"],",
            "lineNumber": 4
          },
          {
            "text": "\t\"plan_name\": \"decouple-file-io\",",
            "lineNumber": 5
          },
          {
            "text": "\t\"agent\": \"atlas\"",
            "lineNumber": 6
          },
          {
            "text": "}",
            "lineNumber": 7
          }
        ]
      },
      "score": 0.15522736310958862
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./tests/idempotency.test.ts",
        "range": {
          "startPosition": {
            "line": 225,
            "column": 3
          },
          "endPosition": {
            "line": 259,
            "column": 3
          }
        },
        "contents": "test(\"96h/1e0/27g: bead fixtures (mutual-pairs, cart, topo, arrow-chain, order-repo-27g, factory-refs, rate-limit, container-di, factory-method-calls) must converge\", async () =&gt; {\n\tconst fixtures = [\n\t\t\"fixtures/test-mutual-pairs.ts\",\n\t\t\"fixtures/test-cart-pingpong.ts\",\n\t\t\"fixtures/test-topo-order-sensitive.ts\",\n\t\t\"fixtures/test-arrow-chain.ts\",\n\t\t\"fixtures/test-order-repo-27g.ts\",\n\t\t\"fixtures/test-factory-refs.ts\",\n\t\t\"fixtures/test-rate-limit-pattern.ts\",\n\t\t\"fixtures/test-container-di.ts\",\n\t\t\"fixtures/test-factory-method-calls.ts\",\n\t];\n\n\tfor (const fixture of fixtures) {\n\t\tconst content = readFileSync(fixture, \"utf-8\");\n\t\tsetupTestDir();\n\t\tconst filePath = createTestFile(\"bead-fixture.ts\", content);\n\n\t\tlet prevViolations = Number.POSITIVE_INFINITY;\n\t\tfor (let i = 0; i &lt; 5; i++) {\n\t\t\tconst [result] = await analyzeFiles([filePath], defaultConfig);\n\t\t\tconst count =\n\t\t\t\t(result?.violations.length ?? 0) + (result?.nestedFunctionViolations.length ?? 0);\n\t\t\texpect(count).toBeLessThanOrEqual(prevViolations);\n\t\t\tprevViolations = count;\n\t\t\tif (count === 0) break;\n\t\t\tawait fixFiles([filePath], defaultConfig);\n\t\t}\n\n\t\texpect(prevViolations).toBe(0);\n\t\tcleanupTestDir();\n\t}\n});",
        "signatures": {},
        "detailedLines": [
          {
            "text": "test(\"96h/1e0/27g: bead fixtures (mutual-pairs, cart, topo, arrow-chain, order-repo-27g, factory-refs, rate-limit, container-di, factory-method-calls) must converge\", async () =&gt; {",
            "lineNumber": 228
          },
          {
            "text": "\tconst fixtures = [",
            "lineNumber": 229
          },
          {
            "text": "\t\t\"fixtures/test-mutual-pairs.ts\",",
            "lineNumber": 230
          },
          {
            "text": "\t\t\"fixtures/test-cart-pingpong.ts\",",
            "lineNumber": 231
          },
          {
            "text": "\t\t\"fixtures/test-topo-order-sensitive.ts\",",
            "lineNumber": 232
          },
          {
            "text": "\t\t\"fixtures/test-arrow-chain.ts\",",
            "lineNumber": 233
          },
          {
            "text": "\t\t\"fixtures/test-order-repo-27g.ts\",",
            "lineNumber": 234
          },
          {
            "text": "\t\t\"fixtures/test-factory-refs.ts\",",
            "lineNumber": 235
          },
          {
            "text": "\t\t\"fixtures/test-rate-limit-pattern.ts\",",
            "lineNumber": 236
          },
          {
            "text": "\t\t\"fixtures/test-container-di.ts\",",
            "lineNumber": 237
          },
          {
            "text": "\t\t\"fixtures/test-factory-method-calls.ts\",",
            "lineNumber": 238
          },
          {
            "text": "\t];",
            "lineNumber": 239
          },
          {
            "lineNumber": 240
          },
          {
            "text": "\tfor (const fixture of fixtures) {",
            "lineNumber": 241
          },
          {
            "text": "\t\tconst content = readFileSync(fixture, \"utf-8\");",
            "lineNumber": 242
          },
          {
            "text": "\t\tsetupTestDir();",
            "lineNumber": 243
          },
          {
            "text": "\t\tconst filePath = createTestFile(\"bead-fixture.ts\", content);",
            "lineNumber": 244
          },
          {
            "lineNumber": 245
          },
          {
            "text": "\t\tlet prevViolations = Number.POSITIVE_INFINITY;",
            "lineNumber": 246
          },
          {
            "text": "\t\tfor (let i = 0; i &lt; 5; i++) {",
            "lineNumber": 247
          },
          {
            "text": "\t\t\tconst [result] = await analyzeFiles([filePath], defaultConfig);",
            "lineNumber": 248
          },
          {
            "text": "\t\t\tconst count =",
            "lineNumber": 249
          },
          {
            "text": "\t\t\t\t(result?.violations.length ?? 0) + (result?.nestedFunctionViolations.length ?? 0);",
            "lineNumber": 250
          },
          {
            "text": "\t\t\texpect(count).toBeLessThanOrEqual(prevViolations);",
            "lineNumber": 251
          },
          {
            "text": "\t\t\tprevViolations = count;",
            "lineNumber": 252
          },
          {
            "text": "\t\t\tif (count === 0) break;",
            "lineNumber": 253
          },
          {
            "text": "\t\t\tawait fixFiles([filePath], defaultConfig);",
            "lineNumber": 254
          },
          {
            "text": "\t\t}",
            "lineNumber": 255
          },
          {
            "lineNumber": 256
          },
          {
            "text": "\t\texpect(prevViolations).toBe(0);",
            "lineNumber": 257
          },
          {
            "text": "\t\tcleanupTestDir();",
            "lineNumber": 258
          },
          {
            "text": "\t}",
            "lineNumber": 259
          },
          {
            "text": "});",
            "lineNumber": 260
          }
        ]
      },
      "score": 0.15347430109977722
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.beads/.gitignore",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 46
          }
        },
        "contents": "# SQLite databases\n*.db\n*.db?*\n*.db-journal\n*.db-wal\n*.db-shm\n\n# Daemon runtime files\ndaemon.lock\ndaemon.log\ndaemon.pid\nbd.sock\nsync-state.json\nlast-touched\n\n# Local version tracking (prevents upgrade notification spam after git ops)\n.local_version\n\n# Legacy database files\ndb.sqlite\nbd.db\n\n# Worktree redirect file (contains relative path to main repo's .beads/)\n# Must not be committed as paths would be wrong in other clones\nredirect\n\n# Merge artifacts (temporary files from 3-way merge)\nbeads.base.jsonl\nbeads.base.meta.json\nbeads.left.jsonl\nbeads.left.meta.json\nbeads.right.jsonl\nbeads.right.meta.json\n\n# Sync state (local-only, per-machine)\n# These files are machine-specific and should not be shared across clones\n.sync.lock\n.jsonl.lock\nsync_base.jsonl\nexport-state/\n\n# NOTE: Do NOT add negation patterns (e.g., !issues.jsonl) here.\n# They would override fork protection in .git/info/exclude, allowing\n# contributors to accidentally commit upstream issue databases.\n# The JSONL files (issues.jsonl, interactions.jsonl) and config files\n# are tracked by git by default since no pattern above ignores them.",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# SQLite databases",
            "lineNumber": 1
          },
          {
            "text": "*.db",
            "lineNumber": 2
          },
          {
            "text": "*.db?*",
            "lineNumber": 3
          },
          {
            "text": "*.db-journal",
            "lineNumber": 4
          },
          {
            "text": "*.db-wal",
            "lineNumber": 5
          },
          {
            "text": "*.db-shm",
            "lineNumber": 6
          },
          {
            "lineNumber": 7
          },
          {
            "text": "# Daemon runtime files",
            "lineNumber": 8
          },
          {
            "text": "daemon.lock",
            "lineNumber": 9
          },
          {
            "text": "daemon.log",
            "lineNumber": 10
          },
          {
            "text": "daemon.pid",
            "lineNumber": 11
          },
          {
            "text": "bd.sock",
            "lineNumber": 12
          },
          {
            "text": "sync-state.json",
            "lineNumber": 13
          },
          {
            "text": "last-touched",
            "lineNumber": 14
          },
          {
            "lineNumber": 15
          },
          {
            "text": "# Local version tracking (prevents upgrade notification spam after git ops)",
            "lineNumber": 16
          },
          {
            "text": ".local_version",
            "lineNumber": 17
          },
          {
            "lineNumber": 18
          },
          {
            "text": "# Legacy database files",
            "lineNumber": 19
          },
          {
            "text": "db.sqlite",
            "lineNumber": 20
          },
          {
            "text": "bd.db",
            "lineNumber": 21
          },
          {
            "lineNumber": 22
          },
          {
            "text": "# Worktree redirect file (contains relative path to main repo's .beads/)",
            "lineNumber": 23
          },
          {
            "text": "# Must not be committed as paths would be wrong in other clones",
            "lineNumber": 24
          },
          {
            "text": "redirect",
            "lineNumber": 25
          },
          {
            "lineNumber": 26
          },
          {
            "text": "# Merge artifacts (temporary files from 3-way merge)",
            "lineNumber": 27
          },
          {
            "text": "beads.base.jsonl",
            "lineNumber": 28
          },
          {
            "text": "beads.base.meta.json",
            "lineNumber": 29
          },
          {
            "text": "beads.left.jsonl",
            "lineNumber": 30
          },
          {
            "text": "beads.left.meta.json",
            "lineNumber": 31
          },
          {
            "text": "beads.right.jsonl",
            "lineNumber": 32
          },
          {
            "text": "beads.right.meta.json",
            "lineNumber": 33
          },
          {
            "lineNumber": 34
          },
          {
            "text": "# Sync state (local-only, per-machine)",
            "lineNumber": 35
          },
          {
            "text": "# These files are machine-specific and should not be shared across clones",
            "lineNumber": 36
          },
          {
            "text": ".sync.lock",
            "lineNumber": 37
          },
          {
            "text": ".jsonl.lock",
            "lineNumber": 38
          },
          {
            "text": "sync_base.jsonl",
            "lineNumber": 39
          },
          {
            "text": "export-state/",
            "lineNumber": 40
          },
          {
            "lineNumber": 41
          },
          {
            "text": "# NOTE: Do NOT add negation patterns (e.g., !issues.jsonl) here.",
            "lineNumber": 42
          },
          {
            "text": "# They would override fork protection in .git/info/exclude, allowing",
            "lineNumber": 43
          },
          {
            "text": "# contributors to accidentally commit upstream issue databases.",
            "lineNumber": 44
          },
          {
            "text": "# The JSONL files (issues.jsonl, interactions.jsonl) and config files",
            "lineNumber": 45
          },
          {
            "text": "# are tracked by git by default since no pattern above ignores them.",
            "lineNumber": 46
          }
        ]
      },
      "score": 0.14972186088562012
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/PRD.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 59
          }
        },
        "contents": "# Stepdown Rule Analyzer - Product Requirements Document\n\n## Overview\n\nA TypeScript AST analyzer that enforces the stepdown rule for function organization in codebases. The stepdown rule organizes code from high-level concepts at the top to low-level implementation details at the bottom.\n\n## Problem Statement\n\nLarge TypeScript codebases often suffer from poor function organization, making code harder to read and maintain. Functions are scattered without logical hierarchy, with helper functions appearing before main logic and high-level concepts buried in implementation details.\n\n## Solution\n\nA CLI tool that analyzes TypeScript files and enforces the stepdown rule:\n\n- Entry points and high-level functions appear first\n- Mid-level abstractions follow\n- Low-level implementation details appear last\n- Dependencies flow downward (A calls B â†’ A appears before B)\n\n## Core Requirements\n\n### Functional Requirements\n\n#### 1. AST Analysis\n\n- Parse TypeScript files using official TypeScript compiler API\n- Identify function declarations and top-level arrow function variables\n- Build call graph of function dependencies\n- Detect stepdown rule violations\n\n#### 2. Function Types Supported\n\n- Function declarations: &#96;function name() {}&#96;\n- Top-level arrow function variables: &#96;const name = () =&gt; {}&#96;\n- Variable declarations with function expressions: &#96;const name = function() {}&#96;\n\n#### 3. Analysis Scope\n\n- Analyze all functions in each file\n- Build complete call graph within file boundaries\n- Handle circular dependencies (report as errors)\n- Respect configurable ignore patterns\n\n#### 4. Auto-Fix Capability\n\n- Reorder functions to comply with stepdown rule\n- Preserve comments, imports, and exports\n- Maintain relative order of functions at same dependency level\n- Handle cases where AFVs cannot be converted to function declarations\n\n#### 5. Reporting\n\n- Console output with color-coded errors\n- JSON output for CI/CD integration\n- Detailed violation information: file, line, function, dependency\n- Progress indicator for large codebases\n\n### Non-Functional Requirements",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# Stepdown Rule Analyzer - Product Requirements Document",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "## Overview",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "A TypeScript AST analyzer that enforces the stepdown rule for function organization in codebases. The stepdown rule organizes code from high-level concepts at the top to low-level implementation details at the bottom.",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "## Problem Statement",
            "lineNumber": 7
          },
          {
            "lineNumber": 8
          },
          {
            "text": "Large TypeScript codebases often suffer from poor function organization, making code harder to read and maintain. Functions are scattered without logical hierarchy, with helper functions appearing before main logic and high-level concepts buried in implementation details.",
            "lineNumber": 9
          },
          {
            "lineNumber": 10
          },
          {
            "text": "## Solution",
            "lineNumber": 11
          },
          {
            "lineNumber": 12
          },
          {
            "text": "A CLI tool that analyzes TypeScript files and enforces the stepdown rule:",
            "lineNumber": 13
          },
          {
            "lineNumber": 14
          },
          {
            "text": "- Entry points and high-level functions appear first",
            "lineNumber": 15
          },
          {
            "text": "- Mid-level abstractions follow",
            "lineNumber": 16
          },
          {
            "text": "- Low-level implementation details appear last",
            "lineNumber": 17
          },
          {
            "text": "- Dependencies flow downward (A calls B â†’ A appears before B)",
            "lineNumber": 18
          },
          {
            "lineNumber": 19
          },
          {
            "text": "## Core Requirements",
            "lineNumber": 20
          },
          {
            "lineNumber": 21
          },
          {
            "text": "### Functional Requirements",
            "lineNumber": 22
          },
          {
            "lineNumber": 23
          },
          {
            "text": "#### 1. AST Analysis",
            "lineNumber": 24
          },
          {
            "lineNumber": 25
          },
          {
            "text": "- Parse TypeScript files using official TypeScript compiler API",
            "lineNumber": 26
          },
          {
            "text": "- Identify function declarations and top-level arrow function variables",
            "lineNumber": 27
          },
          {
            "text": "- Build call graph of function dependencies",
            "lineNumber": 28
          },
          {
            "text": "- Detect stepdown rule violations",
            "lineNumber": 29
          },
          {
            "lineNumber": 30
          },
          {
            "text": "#### 2. Function Types Supported",
            "lineNumber": 31
          },
          {
            "lineNumber": 32
          },
          {
            "text": "- Function declarations: &#96;function name() {}&#96;",
            "lineNumber": 33
          },
          {
            "text": "- Top-level arrow function variables: &#96;const name = () =&gt; {}&#96;",
            "lineNumber": 34
          },
          {
            "text": "- Variable declarations with function expressions: &#96;const name = function() {}&#96;",
            "lineNumber": 35
          },
          {
            "lineNumber": 36
          },
          {
            "text": "#### 3. Analysis Scope",
            "lineNumber": 37
          },
          {
            "lineNumber": 38
          },
          {
            "text": "- Analyze all functions in each file",
            "lineNumber": 39
          },
          {
            "text": "- Build complete call graph within file boundaries",
            "lineNumber": 40
          },
          {
            "text": "- Handle circular dependencies (report as errors)",
            "lineNumber": 41
          },
          {
            "text": "- Respect configurable ignore patterns",
            "lineNumber": 42
          },
          {
            "lineNumber": 43
          },
          {
            "text": "#### 4. Auto-Fix Capability",
            "lineNumber": 44
          },
          {
            "lineNumber": 45
          },
          {
            "text": "- Reorder functions to comply with stepdown rule",
            "lineNumber": 46
          },
          {
            "text": "- Preserve comments, imports, and exports",
            "lineNumber": 47
          },
          {
            "text": "- Maintain relative order of functions at same dependency level",
            "lineNumber": 48
          },
          {
            "text": "- Handle cases where AFVs cannot be converted to function declarations",
            "lineNumber": 49
          },
          {
            "lineNumber": 50
          },
          {
            "text": "#### 5. Reporting",
            "lineNumber": 51
          },
          {
            "lineNumber": 52
          },
          {
            "text": "- Console output with color-coded errors",
            "lineNumber": 53
          },
          {
            "text": "- JSON output for CI/CD integration",
            "lineNumber": 54
          },
          {
            "text": "- Detailed violation information: file, line, function, dependency",
            "lineNumber": 55
          },
          {
            "text": "- Progress indicator for large codebases",
            "lineNumber": 56
          },
          {
            "lineNumber": 57
          },
          {
            "text": "### Non-Functional Requirements",
            "lineNumber": 58
          }
        ]
      },
      "score": 0.12484574317932129
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./AGENTS.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 34
          }
        },
        "contents": "- Use bun instead of node.\n    - &#96;npm run&#96; &gt; &#96;bun run&#96;\n    - &#96;npx&#96; &gt; &#96;bunx&#96;\n- No Barrel Files. Import directly from source files.\n    - âŒ DON'T: &#96;import { foo } from \"./index\"&#96; or &#96;import { foo } from \"./folder\"&#96;\n    - âœ… DO: &#96;import { foo } from \"./folder/foo\"&#96;\n- Use Mermaid for diagrams.\n- do not fix unusued functions or parameters with underscores, delete them.\n\n## Landing the Plane (Session Completion)\n\n**When ending a work session**, you MUST complete ALL steps below. Work is NOT complete until &#96;git push&#96; succeeds.\n\n**MANDATORY WORKFLOW:**\n\n1. **File issues for remaining work** - Create issues for anything that needs follow-up\n2. **Run quality gates** (if code changed) - Tests, linters, builds\n3. **Update issue status** - Close finished work, update in-progress items\n4. **PUSH TO REMOTE** - This is MANDATORY:\n   &#96;&#96;&#96;bash\n   git pull --rebase\n   bd sync\n   git push\n   git status  # MUST show \"up to date with origin\"\n   &#96;&#96;&#96;\n5. **Clean up** - Clear stashes, prune remote branches\n6. **Verify** - All changes committed AND pushed\n7. **Hand off** - Provide context for next session\n\n**CRITICAL RULES:**\n- Work is NOT complete until &#96;git push&#96; succeeds\n- NEVER stop before pushing - that leaves work stranded locally\n- NEVER say \"ready to push when you are\" - YOU must push\n- If push fails, resolve and retry until it succeeds",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- Use bun instead of node.",
            "lineNumber": 1
          },
          {
            "text": "    - &#96;npm run&#96; &gt; &#96;bun run&#96;",
            "lineNumber": 2
          },
          {
            "text": "    - &#96;npx&#96; &gt; &#96;bunx&#96;",
            "lineNumber": 3
          },
          {
            "text": "- No Barrel Files. Import directly from source files.",
            "lineNumber": 4
          },
          {
            "text": "    - âŒ DON'T: &#96;import { foo } from \"./index\"&#96; or &#96;import { foo } from \"./folder\"&#96;",
            "lineNumber": 5
          },
          {
            "text": "    - âœ… DO: &#96;import { foo } from \"./folder/foo\"&#96;",
            "lineNumber": 6
          },
          {
            "text": "- Use Mermaid for diagrams.",
            "lineNumber": 7
          },
          {
            "text": "- do not fix unusued functions or parameters with underscores, delete them.",
            "lineNumber": 8
          },
          {
            "lineNumber": 9
          },
          {
            "text": "## Landing the Plane (Session Completion)",
            "lineNumber": 10
          },
          {
            "lineNumber": 11
          },
          {
            "text": "**When ending a work session**, you MUST complete ALL steps below. Work is NOT complete until &#96;git push&#96; succeeds.",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "**MANDATORY WORKFLOW:**",
            "lineNumber": 14
          },
          {
            "lineNumber": 15
          },
          {
            "text": "1. **File issues for remaining work** - Create issues for anything that needs follow-up",
            "lineNumber": 16
          },
          {
            "text": "2. **Run quality gates** (if code changed) - Tests, linters, builds",
            "lineNumber": 17
          },
          {
            "text": "3. **Update issue status** - Close finished work, update in-progress items",
            "lineNumber": 18
          },
          {
            "text": "4. **PUSH TO REMOTE** - This is MANDATORY:",
            "lineNumber": 19
          },
          {
            "text": "   &#96;&#96;&#96;bash",
            "lineNumber": 20
          },
          {
            "text": "   git pull --rebase",
            "lineNumber": 21
          },
          {
            "text": "   bd sync",
            "lineNumber": 22
          },
          {
            "text": "   git push",
            "lineNumber": 23
          },
          {
            "text": "   git status  # MUST show \"up to date with origin\"",
            "lineNumber": 24
          },
          {
            "text": "   &#96;&#96;&#96;",
            "lineNumber": 25
          },
          {
            "text": "5. **Clean up** - Clear stashes, prune remote branches",
            "lineNumber": 26
          },
          {
            "text": "6. **Verify** - All changes committed AND pushed",
            "lineNumber": 27
          },
          {
            "text": "7. **Hand off** - Provide context for next session",
            "lineNumber": 28
          },
          {
            "lineNumber": 29
          },
          {
            "text": "**CRITICAL RULES:**",
            "lineNumber": 30
          },
          {
            "text": "- Work is NOT complete until &#96;git push&#96; succeeds",
            "lineNumber": 31
          },
          {
            "text": "- NEVER stop before pushing - that leaves work stranded locally",
            "lineNumber": 32
          },
          {
            "text": "- NEVER say \"ready to push when you are\" - YOU must push",
            "lineNumber": 33
          },
          {
            "text": "- If push fails, resolve and retry until it succeeds",
            "lineNumber": 34
          }
        ]
      },
      "score": 0.12461189925670624
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./README.md",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 99
          }
        },
        "contents": "# Stepdown Rule Analyzer\n\nA TypeScript AST analyzer that enforces the stepdown rule for function organization in codebases. The stepdown rule organizes code from high-level concepts at the top to low-level implementation details at the bottom.\n\n## Installation\n\nThis is a local package. Clone and install it:\n\n&#96;&#96;&#96;bash\n# Clone the repository\ngit clone https://github.com/graffhyrum/stepdown-rule.git\ncd stepdown-rule\n\n# Install dependencies\nbun install\n\n# Build the package\nbun run build\n\n# Link globally (optional, for CLI access)\nbun link\n&#96;&#96;&#96;\n\n### Local Usage in Another Project\n\nAfter linking, use it in any project:\n\n&#96;&#96;&#96;bash\n# Link the package in your project\ncd /path/to/your-project\nbun link @stepdown/analyzer\n&#96;&#96;&#96;\n\nThen import and use programmatically:\n\n&#96;&#96;&#96;typescript\nimport { analyzeFiles, fixFiles } from \"@stepdown/analyzer\";\n\nconst results = await analyzeFiles([\"src/**/*.ts\"], {\n  analyzeArrowFunctions: true,\n  analyzeExportsOnly: false,\n  reportCircularDependencies: true,\n});\n\nconsole.log(results);\n&#96;&#96;&#96;\n\nOr use the CLI:\n\n&#96;&#96;&#96;bash\nstepdown-rule \"src/**/*.ts\"\n&#96;&#96;&#96;\n\n## Usage\n\n### CLI\n\n&#96;&#96;&#96;bash\n# Analyze current directory\nstepdown-rule\n\n# Analyze specific files/globs\nstepdown-rule \"src/**/*.ts\" \"lib/**/*.ts\"\n\n# Auto-fix violations\nstepdown-rule --fix\n\n# Show circular dependencies (verbose mode)\nstepdown-rule --verbose\n\n# JSON output for CI\nstepdown-rule --json --output-file results.json\n\n# Custom ignore patterns\nstepdown-rule --ignore \"test/**/*\" \"generated/**/*\"\n&#96;&#96;&#96;\n\n### Programmatic\n\n&#96;&#96;&#96;typescript\nimport { analyzeFiles, fixFiles } from \"@stepdown/analyzer\";\n\nconst results = await analyzeFiles([\"src/**/*.ts\"], {\n  analyzeArrowFunctions: true,\n  analyzeExportsOnly: false,\n  reportCircularDependencies: true,\n});\n\nconsole.log(results);\n&#96;&#96;&#96;\n\n## What is the Stepdown Rule?\n\nThe stepdown rule organizes functions in a file from high-level to low-level:\n\n&#96;&#96;&#96;typescript\n// âœ… Good: Stepdown rule followed\nfunction main() {\n  const user = createUser(\"John\", \"john@example.com\", \"password123\");",
        "signatures": {},
        "detailedLines": [
          {
            "text": "# Stepdown Rule Analyzer",
            "lineNumber": 1
          },
          {
            "lineNumber": 2
          },
          {
            "text": "A TypeScript AST analyzer that enforces the stepdown rule for function organization in codebases. The stepdown rule organizes code from high-level concepts at the top to low-level implementation details at the bottom.",
            "lineNumber": 3
          },
          {
            "lineNumber": 4
          },
          {
            "text": "## Installation",
            "lineNumber": 5
          },
          {
            "lineNumber": 6
          },
          {
            "text": "This is a local package. Clone and install it:",
            "lineNumber": 7
          },
          {
            "lineNumber": 8
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 9
          },
          {
            "text": "# Clone the repository",
            "lineNumber": 10
          },
          {
            "text": "git clone https://github.com/graffhyrum/stepdown-rule.git",
            "lineNumber": 11
          },
          {
            "text": "cd stepdown-rule",
            "lineNumber": 12
          },
          {
            "lineNumber": 13
          },
          {
            "text": "# Install dependencies",
            "lineNumber": 14
          },
          {
            "text": "bun install",
            "lineNumber": 15
          },
          {
            "lineNumber": 16
          },
          {
            "text": "# Build the package",
            "lineNumber": 17
          },
          {
            "text": "bun run build",
            "lineNumber": 18
          },
          {
            "lineNumber": 19
          },
          {
            "text": "# Link globally (optional, for CLI access)",
            "lineNumber": 20
          },
          {
            "text": "bun link",
            "lineNumber": 21
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 22
          },
          {
            "lineNumber": 23
          },
          {
            "text": "### Local Usage in Another Project",
            "lineNumber": 24
          },
          {
            "lineNumber": 25
          },
          {
            "text": "After linking, use it in any project:",
            "lineNumber": 26
          },
          {
            "lineNumber": 27
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 28
          },
          {
            "text": "# Link the package in your project",
            "lineNumber": 29
          },
          {
            "text": "cd /path/to/your-project",
            "lineNumber": 30
          },
          {
            "text": "bun link @stepdown/analyzer",
            "lineNumber": 31
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 32
          },
          {
            "lineNumber": 33
          },
          {
            "text": "Then import and use programmatically:",
            "lineNumber": 34
          },
          {
            "lineNumber": 35
          },
          {
            "text": "&#96;&#96;&#96;typescript",
            "lineNumber": 36
          },
          {
            "text": "import { analyzeFiles, fixFiles } from \"@stepdown/analyzer\";",
            "lineNumber": 37
          },
          {
            "lineNumber": 38
          },
          {
            "text": "const results = await analyzeFiles([\"src/**/*.ts\"], {",
            "lineNumber": 39
          },
          {
            "text": "  analyzeArrowFunctions: true,",
            "lineNumber": 40
          },
          {
            "text": "  analyzeExportsOnly: false,",
            "lineNumber": 41
          },
          {
            "text": "  reportCircularDependencies: true,",
            "lineNumber": 42
          },
          {
            "text": "});",
            "lineNumber": 43
          },
          {
            "lineNumber": 44
          },
          {
            "text": "console.log(results);",
            "lineNumber": 45
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 46
          },
          {
            "lineNumber": 47
          },
          {
            "text": "Or use the CLI:",
            "lineNumber": 48
          },
          {
            "lineNumber": 49
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 50
          },
          {
            "text": "stepdown-rule \"src/**/*.ts\"",
            "lineNumber": 51
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 52
          },
          {
            "lineNumber": 53
          },
          {
            "text": "## Usage",
            "lineNumber": 54
          },
          {
            "lineNumber": 55
          },
          {
            "text": "### CLI",
            "lineNumber": 56
          },
          {
            "lineNumber": 57
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 58
          },
          {
            "text": "# Analyze current directory",
            "lineNumber": 59
          },
          {
            "text": "stepdown-rule",
            "lineNumber": 60
          },
          {
            "lineNumber": 61
          },
          {
            "text": "# Analyze specific files/globs",
            "lineNumber": 62
          },
          {
            "text": "stepdown-rule \"src/**/*.ts\" \"lib/**/*.ts\"",
            "lineNumber": 63
          },
          {
            "lineNumber": 64
          },
          {
            "text": "# Auto-fix violations",
            "lineNumber": 65
          },
          {
            "text": "stepdown-rule --fix",
            "lineNumber": 66
          },
          {
            "lineNumber": 67
          },
          {
            "text": "# Show circular dependencies (verbose mode)",
            "lineNumber": 68
          },
          {
            "text": "stepdown-rule --verbose",
            "lineNumber": 69
          },
          {
            "lineNumber": 70
          },
          {
            "text": "# JSON output for CI",
            "lineNumber": 71
          },
          {
            "text": "stepdown-rule --json --output-file results.json",
            "lineNumber": 72
          },
          {
            "lineNumber": 73
          },
          {
            "text": "# Custom ignore patterns",
            "lineNumber": 74
          },
          {
            "text": "stepdown-rule --ignore \"test/**/*\" \"generated/**/*\"",
            "lineNumber": 75
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 76
          },
          {
            "lineNumber": 77
          },
          {
            "text": "### Programmatic",
            "lineNumber": 78
          },
          {
            "lineNumber": 79
          },
          {
            "text": "&#96;&#96;&#96;typescript",
            "lineNumber": 80
          },
          {
            "text": "import { analyzeFiles, fixFiles } from \"@stepdown/analyzer\";",
            "lineNumber": 81
          },
          {
            "lineNumber": 82
          },
          {
            "text": "const results = await analyzeFiles([\"src/**/*.ts\"], {",
            "lineNumber": 83
          },
          {
            "text": "  analyzeArrowFunctions: true,",
            "lineNumber": 84
          },
          {
            "text": "  analyzeExportsOnly: false,",
            "lineNumber": 85
          },
          {
            "text": "  reportCircularDependencies: true,",
            "lineNumber": 86
          },
          {
            "text": "});",
            "lineNumber": 87
          },
          {
            "lineNumber": 88
          },
          {
            "text": "console.log(results);",
            "lineNumber": 89
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 90
          },
          {
            "lineNumber": 91
          },
          {
            "text": "## What is the Stepdown Rule?",
            "lineNumber": 92
          },
          {
            "lineNumber": 93
          },
          {
            "text": "The stepdown rule organizes functions in a file from high-level to low-level:",
            "lineNumber": 94
          },
          {
            "lineNumber": 95
          },
          {
            "text": "&#96;&#96;&#96;typescript",
            "lineNumber": 96
          },
          {
            "text": "// âœ… Good: Stepdown rule followed",
            "lineNumber": 97
          },
          {
            "text": "function main() {",
            "lineNumber": 98
          },
          {
            "text": "  const user = createUser(\"John\", \"john@example.com\", \"password123\");",
            "lineNumber": 99
          }
        ]
      },
      "score": 0.10759115219116211
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./biome.json",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 95,
            "column": 3
          }
        },
        "contents": "{\n\t\"$schema\": \"https://biomejs.dev/schemas/2.3.14/schema.json\",\n\t\"vcs\": {\n\t\t\"enabled\": true,\n\t\t\"clientKind\": \"git\",\n\t\t\"useIgnoreFile\": true\n\t},\n\t\"files\": {\n\t\t\"ignoreUnknown\": false,\n\t\t\"includes\": [\n\t\t\t\"**\",\n\t\t\t\"!node_modules\",\n\t\t\t\"!dist\",\n\t\t\t\"!build\",\n\t\t\t\"!.idea\",\n\t\t\t\"!public\",\n\t\t\t\"!*.test.ts\",\n\t\t\t\"!fixtures\"\n\t\t]\n\t},\n\t\"formatter\": {\n\t\t\"enabled\": true,\n\t\t\"indentStyle\": \"tab\",\n\t\t\"indentWidth\": 2,\n\t\t\"lineEnding\": \"lf\",\n\t\t\"lineWidth\": 100,\n\t\t\"attributePosition\": \"auto\",\n\t\t\"bracketSpacing\": true\n\t},\n\t\"linter\": {\n\t\t\"enabled\": true,\n\t\t\"rules\": {\n\t\t\t\"recommended\": true,\n\t\t\t\"complexity\": {\n\t\t\t\t\"noExcessiveCognitiveComplexity\": {\n\t\t\t\t\t\"level\": \"error\",\n\t\t\t\t\t\"options\": {\n\t\t\t\t\t\t\"maxAllowedComplexity\": 10\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t\"noExcessiveLinesPerFunction\": {\n\t\t\t\t\t\"level\": \"error\",\n\t\t\t\t\t\"options\": {\n\t\t\t\t\t\t\"maxLines\": 50,\n\t\t\t\t\t\t\"skipBlankLines\": true,\n\t\t\t\t\t\t\"skipIifes\": true\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t\"noVoid\": \"error\",\n\t\t\t\t\"noForEach\": \"error\",\n\t\t\t\t\"useSimplifiedLogicExpression\": \"error\",\n\t\t\t\t\"useFlatMap\": \"error\",\n\t\t\t\t\"useWhile\": \"error\"\n\t\t\t},\n\t\t\t\"correctness\": {\n\t\t\t\t\"noUnusedVariables\": \"warn\",\n\t\t\t\t\"noUnusedImports\": \"warn\"\n\t\t\t},\n\t\t\t\"style\": {\n\t\t\t\t\"noNonNullAssertion\": \"warn\",\n\t\t\t\t\"useNodejsImportProtocol\": \"error\",\n\t\t\t\t\"useTemplate\": \"error\",\n\t\t\t\t\"noEnum\": \"error\",\n\t\t\t\t\"noExportedImports\": \"error\",\n\t\t\t\t\"noNegationElse\": \"error\",\n\t\t\t\t\"noNestedTernary\": \"error\",\n\t\t\t\t\"noShoutyConstants\": \"error\",\n\t\t\t\t\"noSubstr\": \"error\",\n\t\t\t\t\"noUnusedTemplateLiteral\": \"error\",\n\t\t\t\t\"noUselessElse\": \"error\",\n\t\t\t\t\"noYodaExpression\": \"error\",\n\t\t\t\t\"useAsConstAssertion\": \"error\",\n\t\t\t\t\"useAtIndex\": \"error\",\n\t\t\t\t\"useCollapsedElseIf\": \"error\",\n\t\t\t\t\"useCollapsedIf\": \"error\",\n\t\t\t\t\"useForOf\": \"error\",\n\t\t\t\t\"useNumberNamespace\": \"error\"\n\t\t\t},\n\t\t\t\"suspicious\": {\n\t\t\t\t\"noExplicitAny\": \"warn\",\n\t\t\t\t\"noVar\": \"error\",\n\t\t\t\t\"useAwait\": \"error\"\n\t\t\t},\n\t\t\t\"nursery\": {\n\t\t\t\t\"useMaxParams\": {\n\t\t\t\t\t\"level\": \"error\",\n\t\t\t\t\t\"options\": {\n\t\t\t\t\t\t\"max\": 3\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\t\"javascript\": {\n\t\t\"formatter\": {\n\t\t\t",
        "signatures": {},
        "detailedLines": [
          {
            "text": "{",
            "lineNumber": 1
          },
          {
            "text": "\t\"$schema\": \"https://biomejs.dev/schemas/2.3.14/schema.json\",",
            "lineNumber": 2
          },
          {
            "text": "\t\"vcs\": {",
            "lineNumber": 3
          },
          {
            "text": "\t\t\"enabled\": true,",
            "lineNumber": 4
          },
          {
            "text": "\t\t\"clientKind\": \"git\",",
            "lineNumber": 5
          },
          {
            "text": "\t\t\"useIgnoreFile\": true",
            "lineNumber": 6
          },
          {
            "text": "\t},",
            "lineNumber": 7
          },
          {
            "text": "\t\"files\": {",
            "lineNumber": 8
          },
          {
            "text": "\t\t\"ignoreUnknown\": false,",
            "lineNumber": 9
          },
          {
            "text": "\t\t\"includes\": [",
            "lineNumber": 10
          },
          {
            "text": "\t\t\t\"**\",",
            "lineNumber": 11
          },
          {
            "text": "\t\t\t\"!node_modules\",",
            "lineNumber": 12
          },
          {
            "text": "\t\t\t\"!dist\",",
            "lineNumber": 13
          },
          {
            "text": "\t\t\t\"!build\",",
            "lineNumber": 14
          },
          {
            "text": "\t\t\t\"!.idea\",",
            "lineNumber": 15
          },
          {
            "text": "\t\t\t\"!public\",",
            "lineNumber": 16
          },
          {
            "text": "\t\t\t\"!*.test.ts\",",
            "lineNumber": 17
          },
          {
            "text": "\t\t\t\"!fixtures\"",
            "lineNumber": 18
          },
          {
            "text": "\t\t]",
            "lineNumber": 19
          },
          {
            "text": "\t},",
            "lineNumber": 20
          },
          {
            "text": "\t\"formatter\": {",
            "lineNumber": 21
          },
          {
            "text": "\t\t\"enabled\": true,",
            "lineNumber": 22
          },
          {
            "text": "\t\t\"indentStyle\": \"tab\",",
            "lineNumber": 23
          },
          {
            "text": "\t\t\"indentWidth\": 2,",
            "lineNumber": 24
          },
          {
            "text": "\t\t\"lineEnding\": \"lf\",",
            "lineNumber": 25
          },
          {
            "text": "\t\t\"lineWidth\": 100,",
            "lineNumber": 26
          },
          {
            "text": "\t\t\"attributePosition\": \"auto\",",
            "lineNumber": 27
          },
          {
            "text": "\t\t\"bracketSpacing\": true",
            "lineNumber": 28
          },
          {
            "text": "\t},",
            "lineNumber": 29
          },
          {
            "text": "\t\"linter\": {",
            "lineNumber": 30
          },
          {
            "text": "\t\t\"enabled\": true,",
            "lineNumber": 31
          },
          {
            "text": "\t\t\"rules\": {",
            "lineNumber": 32
          },
          {
            "text": "\t\t\t\"recommended\": true,",
            "lineNumber": 33
          },
          {
            "text": "\t\t\t\"complexity\": {",
            "lineNumber": 34
          },
          {
            "text": "\t\t\t\t\"noExcessiveCognitiveComplexity\": {",
            "lineNumber": 35
          },
          {
            "text": "\t\t\t\t\t\"level\": \"error\",",
            "lineNumber": 36
          },
          {
            "text": "\t\t\t\t\t\"options\": {",
            "lineNumber": 37
          },
          {
            "text": "\t\t\t\t\t\t\"maxAllowedComplexity\": 10",
            "lineNumber": 38
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 39
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 40
          },
          {
            "text": "\t\t\t\t\"noExcessiveLinesPerFunction\": {",
            "lineNumber": 41
          },
          {
            "text": "\t\t\t\t\t\"level\": \"error\",",
            "lineNumber": 42
          },
          {
            "text": "\t\t\t\t\t\"options\": {",
            "lineNumber": 43
          },
          {
            "text": "\t\t\t\t\t\t\"maxLines\": 50,",
            "lineNumber": 44
          },
          {
            "text": "\t\t\t\t\t\t\"skipBlankLines\": true,",
            "lineNumber": 45
          },
          {
            "text": "\t\t\t\t\t\t\"skipIifes\": true",
            "lineNumber": 46
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 47
          },
          {
            "text": "\t\t\t\t},",
            "lineNumber": 48
          },
          {
            "text": "\t\t\t\t\"noVoid\": \"error\",",
            "lineNumber": 49
          },
          {
            "text": "\t\t\t\t\"noForEach\": \"error\",",
            "lineNumber": 50
          },
          {
            "text": "\t\t\t\t\"useSimplifiedLogicExpression\": \"error\",",
            "lineNumber": 51
          },
          {
            "text": "\t\t\t\t\"useFlatMap\": \"error\",",
            "lineNumber": 52
          },
          {
            "text": "\t\t\t\t\"useWhile\": \"error\"",
            "lineNumber": 53
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 54
          },
          {
            "text": "\t\t\t\"correctness\": {",
            "lineNumber": 55
          },
          {
            "text": "\t\t\t\t\"noUnusedVariables\": \"warn\",",
            "lineNumber": 56
          },
          {
            "text": "\t\t\t\t\"noUnusedImports\": \"warn\"",
            "lineNumber": 57
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 58
          },
          {
            "text": "\t\t\t\"style\": {",
            "lineNumber": 59
          },
          {
            "text": "\t\t\t\t\"noNonNullAssertion\": \"warn\",",
            "lineNumber": 60
          },
          {
            "text": "\t\t\t\t\"useNodejsImportProtocol\": \"error\",",
            "lineNumber": 61
          },
          {
            "text": "\t\t\t\t\"useTemplate\": \"error\",",
            "lineNumber": 62
          },
          {
            "text": "\t\t\t\t\"noEnum\": \"error\",",
            "lineNumber": 63
          },
          {
            "text": "\t\t\t\t\"noExportedImports\": \"error\",",
            "lineNumber": 64
          },
          {
            "text": "\t\t\t\t\"noNegationElse\": \"error\",",
            "lineNumber": 65
          },
          {
            "text": "\t\t\t\t\"noNestedTernary\": \"error\",",
            "lineNumber": 66
          },
          {
            "text": "\t\t\t\t\"noShoutyConstants\": \"error\",",
            "lineNumber": 67
          },
          {
            "text": "\t\t\t\t\"noSubstr\": \"error\",",
            "lineNumber": 68
          },
          {
            "text": "\t\t\t\t\"noUnusedTemplateLiteral\": \"error\",",
            "lineNumber": 69
          },
          {
            "text": "\t\t\t\t\"noUselessElse\": \"error\",",
            "lineNumber": 70
          },
          {
            "text": "\t\t\t\t\"noYodaExpression\": \"error\",",
            "lineNumber": 71
          },
          {
            "text": "\t\t\t\t\"useAsConstAssertion\": \"error\",",
            "lineNumber": 72
          },
          {
            "text": "\t\t\t\t\"useAtIndex\": \"error\",",
            "lineNumber": 73
          },
          {
            "text": "\t\t\t\t\"useCollapsedElseIf\": \"error\",",
            "lineNumber": 74
          },
          {
            "text": "\t\t\t\t\"useCollapsedIf\": \"error\",",
            "lineNumber": 75
          },
          {
            "text": "\t\t\t\t\"useForOf\": \"error\",",
            "lineNumber": 76
          },
          {
            "text": "\t\t\t\t\"useNumberNamespace\": \"error\"",
            "lineNumber": 77
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 78
          },
          {
            "text": "\t\t\t\"suspicious\": {",
            "lineNumber": 79
          },
          {
            "text": "\t\t\t\t\"noExplicitAny\": \"warn\",",
            "lineNumber": 80
          },
          {
            "text": "\t\t\t\t\"noVar\": \"error\",",
            "lineNumber": 81
          },
          {
            "text": "\t\t\t\t\"useAwait\": \"error\"",
            "lineNumber": 82
          },
          {
            "text": "\t\t\t},",
            "lineNumber": 83
          },
          {
            "text": "\t\t\t\"nursery\": {",
            "lineNumber": 84
          },
          {
            "text": "\t\t\t\t\"useMaxParams\": {",
            "lineNumber": 85
          },
          {
            "text": "\t\t\t\t\t\"level\": \"error\",",
            "lineNumber": 86
          },
          {
            "text": "\t\t\t\t\t\"options\": {",
            "lineNumber": 87
          },
          {
            "text": "\t\t\t\t\t\t\"max\": 3",
            "lineNumber": 88
          },
          {
            "text": "\t\t\t\t\t}",
            "lineNumber": 89
          },
          {
            "text": "\t\t\t\t}",
            "lineNumber": 90
          },
          {
            "text": "\t\t\t}",
            "lineNumber": 91
          },
          {
            "text": "\t\t}",
            "lineNumber": 92
          },
          {
            "text": "\t},",
            "lineNumber": 93
          },
          {
            "text": "\t\"javascript\": {",
            "lineNumber": 94
          },
          {
            "text": "\t\t\"formatter\": {",
            "lineNumber": 95
          },
          {
            "text": "\t\t\t",
            "lineNumber": 96
          }
        ]
      },
      "score": 0.09916496276855469
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./docs/PRD.md",
        "range": {
          "startPosition": {
            "line": 53
          },
          "endPosition": {
            "line": 154
          }
        },
        "contents": "- JSON output for CI/CD integration\n- Detailed violation information: file, line, function, dependency\n- Progress indicator for large codebases\n\n### Non-Functional Requirements\n\n#### 1. Performance\n\n- Process large codebases efficiently\n- Minimal memory footprint\n- Parallel processing where possible\n- Configurable timeout for analysis\n\n#### 2. Usability\n\n- Simple CLI interface with clear help\n- Extensible configuration via config file\n- Sensible defaults\n- Integration with existing tooling (oxlint, prettier)\n\n#### 3. Compatibility\n\n- TypeScript 5.0+\n- Node.js 18+\n- Works with existing project structures\n- No runtime dependencies that conflict with common tooling\n\n## User Interface\n\n### CLI Commands\n\n&#96;&#96;&#96;bash\n# Analyze current directory\nstepdown-rule\n\n# Analyze specific files/globs\nstepdown-rule \"src/**/*.ts\" \"lib/**/*.ts\"\n\n# Auto-fix violations\nstepdown-rule --fix\n\n# JSON output for CI\nstepdown-rule --json --output-file results.json\n\n# Custom ignore patterns\nstepdown-rule --ignore \"test/**/*\" \"generated/**/*\"\n\n# Config file\nstepdown-rule --config .stepdownrc.json\n&#96;&#96;&#96;\n\n### Configuration (.stepdownrc.json)\n\n&#96;&#96;&#96;json\n{\n  \"ignore\": [\"node_modules/**\", \"dist/**\", \"*.test.ts\", \"*.spec.ts\"],\n  \"analyzeArrowFunctions\": true,\n  \"analyzeExportsOnly\": false,\n  \"reportCircularDependencies\": true\n}\n&#96;&#96;&#96;\n\n## Technical Architecture\n\n### Core Components\n\n#### 1. Analyzer (&#96;src/analyzer.ts&#96;)\n\n- TypeScript AST parsing\n- Function extraction and classification\n- Call graph building\n- Violation detection\n\n#### 2. Fixer (&#96;src/fixer.ts&#96;)\n\n- Function reordering algorithm\n- AST modification\n- Source code reconstruction\n- Comment preservation\n\n#### 3. CLI (&#96;src/cli.ts&#96;)\n\n- Command line interface\n- File pattern resolution\n- Output formatting\n- Configuration loading\n\n#### 4. Types (&#96;src/types.ts&#96;)\n\n- Core type definitions\n- AST node wrappers\n- Violation data structures\n- Configuration schema\n\n### Algorithms\n\n#### Call Graph Construction\n\n1. Extract all function definitions with source positions\n2. Analyze function bodies for function calls\n3. Build directed graph: A â†’ B if A calls B",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- JSON output for CI/CD integration",
            "lineNumber": 54
          },
          {
            "text": "- Detailed violation information: file, line, function, dependency",
            "lineNumber": 55
          },
          {
            "text": "- Progress indicator for large codebases",
            "lineNumber": 56
          },
          {
            "lineNumber": 57
          },
          {
            "text": "### Non-Functional Requirements",
            "lineNumber": 58
          },
          {
            "lineNumber": 59
          },
          {
            "text": "#### 1. Performance",
            "lineNumber": 60
          },
          {
            "lineNumber": 61
          },
          {
            "text": "- Process large codebases efficiently",
            "lineNumber": 62
          },
          {
            "text": "- Minimal memory footprint",
            "lineNumber": 63
          },
          {
            "text": "- Parallel processing where possible",
            "lineNumber": 64
          },
          {
            "text": "- Configurable timeout for analysis",
            "lineNumber": 65
          },
          {
            "lineNumber": 66
          },
          {
            "text": "#### 2. Usability",
            "lineNumber": 67
          },
          {
            "lineNumber": 68
          },
          {
            "text": "- Simple CLI interface with clear help",
            "lineNumber": 69
          },
          {
            "text": "- Extensible configuration via config file",
            "lineNumber": 70
          },
          {
            "text": "- Sensible defaults",
            "lineNumber": 71
          },
          {
            "text": "- Integration with existing tooling (oxlint, prettier)",
            "lineNumber": 72
          },
          {
            "lineNumber": 73
          },
          {
            "text": "#### 3. Compatibility",
            "lineNumber": 74
          },
          {
            "lineNumber": 75
          },
          {
            "text": "- TypeScript 5.0+",
            "lineNumber": 76
          },
          {
            "text": "- Node.js 18+",
            "lineNumber": 77
          },
          {
            "text": "- Works with existing project structures",
            "lineNumber": 78
          },
          {
            "text": "- No runtime dependencies that conflict with common tooling",
            "lineNumber": 79
          },
          {
            "lineNumber": 80
          },
          {
            "text": "## User Interface",
            "lineNumber": 81
          },
          {
            "lineNumber": 82
          },
          {
            "text": "### CLI Commands",
            "lineNumber": 83
          },
          {
            "lineNumber": 84
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 85
          },
          {
            "text": "# Analyze current directory",
            "lineNumber": 86
          },
          {
            "text": "stepdown-rule",
            "lineNumber": 87
          },
          {
            "lineNumber": 88
          },
          {
            "text": "# Analyze specific files/globs",
            "lineNumber": 89
          },
          {
            "text": "stepdown-rule \"src/**/*.ts\" \"lib/**/*.ts\"",
            "lineNumber": 90
          },
          {
            "lineNumber": 91
          },
          {
            "text": "# Auto-fix violations",
            "lineNumber": 92
          },
          {
            "text": "stepdown-rule --fix",
            "lineNumber": 93
          },
          {
            "lineNumber": 94
          },
          {
            "text": "# JSON output for CI",
            "lineNumber": 95
          },
          {
            "text": "stepdown-rule --json --output-file results.json",
            "lineNumber": 96
          },
          {
            "lineNumber": 97
          },
          {
            "text": "# Custom ignore patterns",
            "lineNumber": 98
          },
          {
            "text": "stepdown-rule --ignore \"test/**/*\" \"generated/**/*\"",
            "lineNumber": 99
          },
          {
            "lineNumber": 100
          },
          {
            "text": "# Config file",
            "lineNumber": 101
          },
          {
            "text": "stepdown-rule --config .stepdownrc.json",
            "lineNumber": 102
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 103
          },
          {
            "lineNumber": 104
          },
          {
            "text": "### Configuration (.stepdownrc.json)",
            "lineNumber": 105
          },
          {
            "lineNumber": 106
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 107
          },
          {
            "text": "{",
            "lineNumber": 108
          },
          {
            "text": "  \"ignore\": [\"node_modules/**\", \"dist/**\", \"*.test.ts\", \"*.spec.ts\"],",
            "lineNumber": 109
          },
          {
            "text": "  \"analyzeArrowFunctions\": true,",
            "lineNumber": 110
          },
          {
            "text": "  \"analyzeExportsOnly\": false,",
            "lineNumber": 111
          },
          {
            "text": "  \"reportCircularDependencies\": true",
            "lineNumber": 112
          },
          {
            "text": "}",
            "lineNumber": 113
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 114
          },
          {
            "lineNumber": 115
          },
          {
            "text": "## Technical Architecture",
            "lineNumber": 116
          },
          {
            "lineNumber": 117
          },
          {
            "text": "### Core Components",
            "lineNumber": 118
          },
          {
            "lineNumber": 119
          },
          {
            "text": "#### 1. Analyzer (&#96;src/analyzer.ts&#96;)",
            "lineNumber": 120
          },
          {
            "lineNumber": 121
          },
          {
            "text": "- TypeScript AST parsing",
            "lineNumber": 122
          },
          {
            "text": "- Function extraction and classification",
            "lineNumber": 123
          },
          {
            "text": "- Call graph building",
            "lineNumber": 124
          },
          {
            "text": "- Violation detection",
            "lineNumber": 125
          },
          {
            "lineNumber": 126
          },
          {
            "text": "#### 2. Fixer (&#96;src/fixer.ts&#96;)",
            "lineNumber": 127
          },
          {
            "lineNumber": 128
          },
          {
            "text": "- Function reordering algorithm",
            "lineNumber": 129
          },
          {
            "text": "- AST modification",
            "lineNumber": 130
          },
          {
            "text": "- Source code reconstruction",
            "lineNumber": 131
          },
          {
            "text": "- Comment preservation",
            "lineNumber": 132
          },
          {
            "lineNumber": 133
          },
          {
            "text": "#### 3. CLI (&#96;src/cli.ts&#96;)",
            "lineNumber": 134
          },
          {
            "lineNumber": 135
          },
          {
            "text": "- Command line interface",
            "lineNumber": 136
          },
          {
            "text": "- File pattern resolution",
            "lineNumber": 137
          },
          {
            "text": "- Output formatting",
            "lineNumber": 138
          },
          {
            "text": "- Configuration loading",
            "lineNumber": 139
          },
          {
            "lineNumber": 140
          },
          {
            "text": "#### 4. Types (&#96;src/types.ts&#96;)",
            "lineNumber": 141
          },
          {
            "lineNumber": 142
          },
          {
            "text": "- Core type definitions",
            "lineNumber": 143
          },
          {
            "text": "- AST node wrappers",
            "lineNumber": 144
          },
          {
            "text": "- Violation data structures",
            "lineNumber": 145
          },
          {
            "text": "- Configuration schema",
            "lineNumber": 146
          },
          {
            "lineNumber": 147
          },
          {
            "text": "### Algorithms",
            "lineNumber": 148
          },
          {
            "lineNumber": 149
          },
          {
            "text": "#### Call Graph Construction",
            "lineNumber": 150
          },
          {
            "lineNumber": 151
          },
          {
            "text": "1. Extract all function definitions with source positions",
            "lineNumber": 152
          },
          {
            "text": "2. Analyze function bodies for function calls",
            "lineNumber": 153
          },
          {
            "text": "3. Build directed graph: A â†’ B if A calls B",
            "lineNumber": 154
          }
        ]
      },
      "score": 0.08966580033302307
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/types.ts",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 19,
            "column": 1
          }
        },
        "contents": "export interface FunctionInfo {\n\tname: string;\n\tkind: \"declaration\" | \"arrow-function\" | \"function-expression\";\n\tposition: {\n\t\tline: number;\n\t\tcolumn: number;\n\t\tstart: number;\n\t\tend: number;\n\t};\n\tisExported: boolean;\n\tdependencies: string[];\n\tcanBeFunctionDeclaration: boolean;\n\t/** Name of the parent function if this is a nested function, null for top-level functions */\n\tparentFunction: string | null;\n}\n\nexport interface CallSite {\n\tline: number;\n\tcolumn: number;\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export interface FunctionInfo {",
            "lineNumber": 1,
            "isSignature": true
          },
          {
            "text": "\tname: string;",
            "lineNumber": 2
          },
          {
            "text": "\tkind: \"declaration\" | \"arrow-function\" | \"function-expression\";",
            "lineNumber": 3
          },
          {
            "text": "\tposition: {",
            "lineNumber": 4
          },
          {
            "text": "\t\tline: number;",
            "lineNumber": 5
          },
          {
            "text": "\t\tcolumn: number;",
            "lineNumber": 6
          },
          {
            "text": "\t\tstart: number;",
            "lineNumber": 7
          },
          {
            "text": "\t\tend: number;",
            "lineNumber": 8
          },
          {
            "text": "\t};",
            "lineNumber": 9
          },
          {
            "text": "\tisExported: boolean;",
            "lineNumber": 10
          },
          {
            "text": "\tdependencies: string[];",
            "lineNumber": 11
          },
          {
            "text": "\tcanBeFunctionDeclaration: boolean;",
            "lineNumber": 12
          },
          {
            "text": "\t/** Name of the parent function if this is a nested function, null for top-level functions */",
            "lineNumber": 13
          },
          {
            "text": "\tparentFunction: string | null;",
            "lineNumber": 14,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 15,
            "isSignature": true
          },
          {
            "lineNumber": 16
          },
          {
            "text": "export interface CallSite {",
            "lineNumber": 17,
            "isSignature": true
          },
          {
            "text": "\tline: number;",
            "lineNumber": 18
          },
          {
            "text": "\tcolumn: number;",
            "lineNumber": 19,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 20,
            "isSignature": true
          }
        ]
      },
      "score": 0.08758290112018585
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./README.md",
        "range": {
          "startPosition": {
            "line": 97
          },
          "endPosition": {
            "line": 151
          }
        },
        "contents": "function main() {\n  const user = createUser(\"John\", \"john@example.com\", \"password123\");\n  console.log(\"User created:\", user);\n}\n\nfunction createUser(name: string, email: string, password: string): User {\n  if (!validateEmail(email)) throw new Error(\"Invalid email\");\n  const hashedPassword = hashPassword(password);\n  return { id: Math.random().toString(36), name, email, password: hashedPassword };\n}\n\nfunction validateEmail(email: string): boolean {\n  return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);\n}\n\nfunction hashPassword(password: string): string {\n  return crypto.createHash(\"sha256\").update(password).digest(\"hex\");\n}\n&#96;&#96;&#96;\n\nThe rule: within a scope, scope logic comes before subfunction declarations, and if function A calls function B, then A should appear before B in the file.\n\n## How It Works\n\nThe analyzer reports **only actionable violations** - violations that can be fixed by reordering code. Violations involving functions in circular dependency cycles are excluded from reporting because reordering cannot fix them; they require refactoring.\n\n### What Gets Reported\n\nâœ… **Reported**: Functions that call other functions appearing below them\n- These can be fixed by moving the caller after the callee\n\nâŒ **Not Reported**: Functions involved in circular dependencies\n- Example: &#96;funcA â†’ funcB â†’ funcA&#96; (mutual recursion)\n- These require architectural changes, not reordering\n- Often appear in tree traversal algorithms, mutual recursion patterns, or interconnected systems\n\n### Circular Dependencies\n\nCircular dependencies are always detected and reported separately. To understand what's creating cycles in your code:\n\n&#96;&#96;&#96;bash\nstepdown-rule src/analyzer.ts\n# Output shows both violations (fixable) and circular dependencies (architectural)\n&#96;&#96;&#96;\n\nCircular dependencies do NOT prevent the fixer from running, but files with circular dependencies cannot be auto-fixed since reordering won't resolve them.\n\n## Configuration\n\nCreate a &#96;.stepdownrc.json&#96; file (optional):\n\n&#96;&#96;&#96;json\n{\n  \"$schema\": \"./stepdown-schema.json\",",
        "signatures": {},
        "detailedLines": [
          {
            "text": "function main() {",
            "lineNumber": 98
          },
          {
            "text": "  const user = createUser(\"John\", \"john@example.com\", \"password123\");",
            "lineNumber": 99
          },
          {
            "text": "  console.log(\"User created:\", user);",
            "lineNumber": 100
          },
          {
            "text": "}",
            "lineNumber": 101
          },
          {
            "lineNumber": 102
          },
          {
            "text": "function createUser(name: string, email: string, password: string): User {",
            "lineNumber": 103
          },
          {
            "text": "  if (!validateEmail(email)) throw new Error(\"Invalid email\");",
            "lineNumber": 104
          },
          {
            "text": "  const hashedPassword = hashPassword(password);",
            "lineNumber": 105
          },
          {
            "text": "  return { id: Math.random().toString(36), name, email, password: hashedPassword };",
            "lineNumber": 106
          },
          {
            "text": "}",
            "lineNumber": 107
          },
          {
            "lineNumber": 108
          },
          {
            "text": "function validateEmail(email: string): boolean {",
            "lineNumber": 109
          },
          {
            "text": "  return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);",
            "lineNumber": 110
          },
          {
            "text": "}",
            "lineNumber": 111
          },
          {
            "lineNumber": 112
          },
          {
            "text": "function hashPassword(password: string): string {",
            "lineNumber": 113
          },
          {
            "text": "  return crypto.createHash(\"sha256\").update(password).digest(\"hex\");",
            "lineNumber": 114
          },
          {
            "text": "}",
            "lineNumber": 115
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 116
          },
          {
            "lineNumber": 117
          },
          {
            "text": "The rule: within a scope, scope logic comes before subfunction declarations, and if function A calls function B, then A should appear before B in the file.",
            "lineNumber": 118
          },
          {
            "lineNumber": 119
          },
          {
            "text": "## How It Works",
            "lineNumber": 120
          },
          {
            "lineNumber": 121
          },
          {
            "text": "The analyzer reports **only actionable violations** - violations that can be fixed by reordering code. Violations involving functions in circular dependency cycles are excluded from reporting because reordering cannot fix them; they require refactoring.",
            "lineNumber": 122
          },
          {
            "lineNumber": 123
          },
          {
            "text": "### What Gets Reported",
            "lineNumber": 124
          },
          {
            "lineNumber": 125
          },
          {
            "text": "âœ… **Reported**: Functions that call other functions appearing below them",
            "lineNumber": 126
          },
          {
            "text": "- These can be fixed by moving the caller after the callee",
            "lineNumber": 127
          },
          {
            "lineNumber": 128
          },
          {
            "text": "âŒ **Not Reported**: Functions involved in circular dependencies",
            "lineNumber": 129
          },
          {
            "text": "- Example: &#96;funcA â†’ funcB â†’ funcA&#96; (mutual recursion)",
            "lineNumber": 130
          },
          {
            "text": "- These require architectural changes, not reordering",
            "lineNumber": 131
          },
          {
            "text": "- Often appear in tree traversal algorithms, mutual recursion patterns, or interconnected systems",
            "lineNumber": 132
          },
          {
            "lineNumber": 133
          },
          {
            "text": "### Circular Dependencies",
            "lineNumber": 134
          },
          {
            "lineNumber": 135
          },
          {
            "text": "Circular dependencies are always detected and reported separately. To understand what's creating cycles in your code:",
            "lineNumber": 136
          },
          {
            "lineNumber": 137
          },
          {
            "text": "&#96;&#96;&#96;bash",
            "lineNumber": 138
          },
          {
            "text": "stepdown-rule src/analyzer.ts",
            "lineNumber": 139
          },
          {
            "text": "# Output shows both violations (fixable) and circular dependencies (architectural)",
            "lineNumber": 140
          },
          {
            "text": "&#96;&#96;&#96;",
            "lineNumber": 141
          },
          {
            "lineNumber": 142
          },
          {
            "text": "Circular dependencies do NOT prevent the fixer from running, but files with circular dependencies cannot be auto-fixed since reordering won't resolve them.",
            "lineNumber": 143
          },
          {
            "lineNumber": 144
          },
          {
            "text": "## Configuration",
            "lineNumber": 145
          },
          {
            "lineNumber": 146
          },
          {
            "text": "Create a &#96;.stepdownrc.json&#96; file (optional):",
            "lineNumber": 147
          },
          {
            "lineNumber": 148
          },
          {
            "text": "&#96;&#96;&#96;json",
            "lineNumber": 149
          },
          {
            "text": "{",
            "lineNumber": 150
          },
          {
            "text": "  \"$schema\": \"./stepdown-schema.json\",",
            "lineNumber": 151
          }
        ]
      },
      "score": 0.08448492735624313
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./package.json",
        "range": {
          "startPosition": {},
          "endPosition": {
            "line": 61
          }
        },
        "contents": "{\n\t\"name\": \"@stepdown/analyzer\",\n\t\"version\": \"0.1.0\",\n\t\"private\": true,\n\t\"description\": \"TypeScript AST analyzer that enforces the stepdown rule for function organization\",\n\t\"keywords\": [\n\t\t\"ast\",\n\t\t\"code-quality\",\n\t\t\"function-organization\",\n\t\t\"static-analysis\",\n\t\t\"stepdown-rule\",\n\t\t\"typescript\"\n\t],\n\t\"license\": \"MIT\",\n\t\"author\": \"\",\n\t\"repository\": {\n\t\t\"type\": \"git\",\n\t\t\"url\": \"https://github.com/graffhyrum/stepdown-rule.git\"\n\t},\n\t\"bin\": {\n\t\t\"stepdown-rule\": \"./dist/cli.js\"\n\t},\n\t\"files\": [\n\t\t\"dist\",\n\t\t\"README.md\"\n\t],\n\t\"type\": \"module\",\n\t\"main\": \"./dist/index.js\",\n\t\"types\": \"./dist/index.d.ts\",\n\t\"scripts\": {\n\t\t\"build\": \"bun scripts/build.ts &amp;&amp; bun run build:declaration\",\n\t\t\"build:declaration\": \"tsc --emitDeclarationOnly --project tsconfig.types.json\",\n\t\t\"postbuild\": \"bun run --shell bun remove-buildinfo\",\n\t\t\"remove-buildinfo\": \"rm -rf tsconfig.types.tsbuildinfo\",\n\t\t\"dev\": \"bun run src/cli.ts\",\n\t\t\"test\": \"bun test\",\n\t\t\"test:coverage\": \"AGENT=1 bun test --coverage \",\n\t\t\"typecheck\": \"tsc --noEmit\",\n\t\t\"check\": \"biome check .\",\n\t\t\"fix\": \"biome check --write .\",\n\t\t\"custom-hooks\": \"bun run scripts/rule-validator.ts &amp;&amp; bun run dist/cli.js\",\n\t\t\"fastvet\": \"bun run build &amp;&amp; bun typecheck &amp;&amp; bun fix &amp;&amp; bun run custom-hooks  &amp;&amp; bun run test:coverage\",\n\t\t\"vet\": \"bun fastvet\"\n\t},\n\t\"dependencies\": {\n\t\t\"arktype\": \"^2.1.29\",\n\t\t\"commander\": \"^14.0.3\",\n\t\t\"glob\": \"^13.0.2\",\n\t\t\"picocolors\": \"^1.1.1\",\n\t\t\"typescript\": \"^5.9.3\"\n\t},\n\t\"devDependencies\": {\n\t\t\"@biomejs/biome\": \"^2.3.14\",\n\t\t\"@changesets/cli\": \"^2.29.8\",\n\t\t\"@types/bun\": \"^1.3.9\",\n\t\t\"@types/node\": \"^25.2.3\"\n\t},\n\t\"engines\": {\n\t\t\"node\": \"&gt;=18.0.0\"\n\t}\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "{",
            "lineNumber": 1
          },
          {
            "text": "\t\"name\": \"@stepdown/analyzer\",",
            "lineNumber": 2
          },
          {
            "text": "\t\"version\": \"0.1.0\",",
            "lineNumber": 3
          },
          {
            "text": "\t\"private\": true,",
            "lineNumber": 4
          },
          {
            "text": "\t\"description\": \"TypeScript AST analyzer that enforces the stepdown rule for function organization\",",
            "lineNumber": 5
          },
          {
            "text": "\t\"keywords\": [",
            "lineNumber": 6
          },
          {
            "text": "\t\t\"ast\",",
            "lineNumber": 7
          },
          {
            "text": "\t\t\"code-quality\",",
            "lineNumber": 8
          },
          {
            "text": "\t\t\"function-organization\",",
            "lineNumber": 9
          },
          {
            "text": "\t\t\"static-analysis\",",
            "lineNumber": 10
          },
          {
            "text": "\t\t\"stepdown-rule\",",
            "lineNumber": 11
          },
          {
            "text": "\t\t\"typescript\"",
            "lineNumber": 12
          },
          {
            "text": "\t],",
            "lineNumber": 13
          },
          {
            "text": "\t\"license\": \"MIT\",",
            "lineNumber": 14
          },
          {
            "text": "\t\"author\": \"\",",
            "lineNumber": 15
          },
          {
            "text": "\t\"repository\": {",
            "lineNumber": 16
          },
          {
            "text": "\t\t\"type\": \"git\",",
            "lineNumber": 17
          },
          {
            "text": "\t\t\"url\": \"https://github.com/graffhyrum/stepdown-rule.git\"",
            "lineNumber": 18
          },
          {
            "text": "\t},",
            "lineNumber": 19
          },
          {
            "text": "\t\"bin\": {",
            "lineNumber": 20
          },
          {
            "text": "\t\t\"stepdown-rule\": \"./dist/cli.js\"",
            "lineNumber": 21
          },
          {
            "text": "\t},",
            "lineNumber": 22
          },
          {
            "text": "\t\"files\": [",
            "lineNumber": 23
          },
          {
            "text": "\t\t\"dist\",",
            "lineNumber": 24
          },
          {
            "text": "\t\t\"README.md\"",
            "lineNumber": 25
          },
          {
            "text": "\t],",
            "lineNumber": 26
          },
          {
            "text": "\t\"type\": \"module\",",
            "lineNumber": 27
          },
          {
            "text": "\t\"main\": \"./dist/index.js\",",
            "lineNumber": 28
          },
          {
            "text": "\t\"types\": \"./dist/index.d.ts\",",
            "lineNumber": 29
          },
          {
            "text": "\t\"scripts\": {",
            "lineNumber": 30
          },
          {
            "text": "\t\t\"build\": \"bun scripts/build.ts &amp;&amp; bun run build:declaration\",",
            "lineNumber": 31
          },
          {
            "text": "\t\t\"build:declaration\": \"tsc --emitDeclarationOnly --project tsconfig.types.json\",",
            "lineNumber": 32
          },
          {
            "text": "\t\t\"postbuild\": \"bun run --shell bun remove-buildinfo\",",
            "lineNumber": 33
          },
          {
            "text": "\t\t\"remove-buildinfo\": \"rm -rf tsconfig.types.tsbuildinfo\",",
            "lineNumber": 34
          },
          {
            "text": "\t\t\"dev\": \"bun run src/cli.ts\",",
            "lineNumber": 35
          },
          {
            "text": "\t\t\"test\": \"bun test\",",
            "lineNumber": 36
          },
          {
            "text": "\t\t\"test:coverage\": \"AGENT=1 bun test --coverage \",",
            "lineNumber": 37
          },
          {
            "text": "\t\t\"typecheck\": \"tsc --noEmit\",",
            "lineNumber": 38
          },
          {
            "text": "\t\t\"check\": \"biome check .\",",
            "lineNumber": 39
          },
          {
            "text": "\t\t\"fix\": \"biome check --write .\",",
            "lineNumber": 40
          },
          {
            "text": "\t\t\"custom-hooks\": \"bun run scripts/rule-validator.ts &amp;&amp; bun run dist/cli.js\",",
            "lineNumber": 41
          },
          {
            "text": "\t\t\"fastvet\": \"bun run build &amp;&amp; bun typecheck &amp;&amp; bun fix &amp;&amp; bun run custom-hooks  &amp;&amp; bun run test:coverage\",",
            "lineNumber": 42
          },
          {
            "text": "\t\t\"vet\": \"bun fastvet\"",
            "lineNumber": 43
          },
          {
            "text": "\t},",
            "lineNumber": 44
          },
          {
            "text": "\t\"dependencies\": {",
            "lineNumber": 45
          },
          {
            "text": "\t\t\"arktype\": \"^2.1.29\",",
            "lineNumber": 46
          },
          {
            "text": "\t\t\"commander\": \"^14.0.3\",",
            "lineNumber": 47
          },
          {
            "text": "\t\t\"glob\": \"^13.0.2\",",
            "lineNumber": 48
          },
          {
            "text": "\t\t\"picocolors\": \"^1.1.1\",",
            "lineNumber": 49
          },
          {
            "text": "\t\t\"typescript\": \"^5.9.3\"",
            "lineNumber": 50
          },
          {
            "text": "\t},",
            "lineNumber": 51
          },
          {
            "text": "\t\"devDependencies\": {",
            "lineNumber": 52
          },
          {
            "text": "\t\t\"@biomejs/biome\": \"^2.3.14\",",
            "lineNumber": 53
          },
          {
            "text": "\t\t\"@changesets/cli\": \"^2.29.8\",",
            "lineNumber": 54
          },
          {
            "text": "\t\t\"@types/bun\": \"^1.3.9\",",
            "lineNumber": 55
          },
          {
            "text": "\t\t\"@types/node\": \"^25.2.3\"",
            "lineNumber": 56
          },
          {
            "text": "\t},",
            "lineNumber": 57
          },
          {
            "text": "\t\"engines\": {",
            "lineNumber": 58
          },
          {
            "text": "\t\t\"node\": \"&gt;=18.0.0\"",
            "lineNumber": 59
          },
          {
            "text": "\t}",
            "lineNumber": 60
          },
          {
            "text": "}",
            "lineNumber": 61
          }
        ]
      },
      "score": 0.08327219635248184
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/fixer.ts",
        "range": {
          "startPosition": {
            "line": 448,
            "column": 1
          },
          "endPosition": {
            "line": 477,
            "column": 1
          }
        },
        "contents": "interface SortContext {\n\tdependencies: Map&lt;string, string[]&gt;;\n\tvisited: Set&lt;string&gt;;\n\ttemp: Set&lt;string&gt;;\n\tresult: string[];\n\tsourceOrder: Map&lt;string, number&gt;;\n}\n\nfunction visitDependencyNode(name: string, context: SortContext): void {\n\tif\n}",
        "signatures": {},
        "detailedLines": [
          {
            "text": "interface SortContext {",
            "lineNumber": 451,
            "isSignature": true
          },
          {
            "text": "\tdependencies: Map&lt;string, string[]&gt;;",
            "lineNumber": 452
          },
          {
            "text": "\tvisited: Set&lt;string&gt;;",
            "lineNumber": 453
          },
          {
            "text": "\ttemp: Set&lt;string&gt;;",
            "lineNumber": 454
          },
          {
            "text": "\tresult: string[];",
            "lineNumber": 455
          },
          {
            "text": "\tsourceOrder: Map&lt;string, number&gt;;",
            "lineNumber": 456,
            "isSignature": true
          },
          {
            "text": "}",
            "lineNumber": 457,
            "isSignature": true
          },
          {
            "lineNumber": 458
          },
          {
            "text": "function visitDependencyNode(name: string, context: SortContext): void {",
            "lineNumber": 459,
            "isSignature": true
          },
          {
            "text": "\tif",
            "lineNumber": 460
          },
          {
            "text": "}",
            "lineNumber": 478,
            "isSignature": true
          }
        ]
      },
      "score": 0.08192089945077896
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./src/config/schema.ts",
        "range": {
          "startPosition": {
            "line": 21,
            "column": 3
          },
          "endPosition": {
            "line": 25,
            "column": 60
          }
        },
        "contents": "export type Config = typeof ConfigSchema.infer;\n\nexport const ConfigJsonSchema = ConfigSchema.toJsonSchema();",
        "signatures": {},
        "detailedLines": [
          {
            "text": "export type Config = typeof ConfigSchema.infer;",
            "lineNumber": 24,
            "isSignature": true
          },
          {
            "lineNumber": 25
          },
          {
            "text": "export const ConfigJsonSchema = ConfigSchema.toJsonSchema();",
            "lineNumber": 26
          }
        ]
      },
      "score": 0.07782495021820068
    },
    {
      "codeBlock": {
        "relativeWorkspacePath": "./.beads/22-violations-analysis.md",
        "range": {
          "startPosition": {
            "line": 38
          },
          "endPosition": {
            "line": 66
          }
        },
        "contents": "- createSurrealOrderRepository (factory) calls: generateOrderId, calculateOrderTotal, parseSingleOrder, mapValidOrders\n- mapValidOrders, parseSingleOrder call validateAndParseOrder (arrow chain)\n- Fix reordered 5; 9 violations persist\n- Arrow function dep chain not fully captured in topo sort\n\n### src/infrastructure/surreal/wishlist-repository.ts (FM2)\n- addItemToWishlist, removeItemFromWishlist call findByUserId\n- findByUserId calls parseSingleWishlist; createSurrealWishlistRepository calls all\n- Arrow function ordering\n\n### src/instrumentation.ts (FM4)\n- createSpan calls loadOpenTelemetry, setSpanAttributes, recordSpanError\n- Fix reordered 0 then 2 in different runs; violations persist\n\n### src/services/email.ts (FM3/FM4)\n- sendOrderReceiptEmail calls renderOrderReceiptText / createTransporter\n- Fix reordered 2; violations flip between runs\n\n### src/utils/rate-limiting.ts (FM2/FM4)\n- createRateLimit calls setRateLimitHeaders (2 call sites), generateRateLimitKey, createRateLimitError\n- Fix reordered 3; createRateLimit calls setRateLimitHeaders persists\n\n## Gap Summary\n\n1. **Fixer uses forEachChild(sourceFile)** - nested functions never reach reorder pipeline\n2. **Fixer rebuilds deps independently** - does not use analyzer call graph; extraction may differ\n3. **Topo sort reversal** - may not minimize violations when DAG has multiple valid orderings\n4. **No idempotency** - fixâ†’analyze loop oscillates (22â†”27) instead of converging to 0",
        "signatures": {},
        "detailedLines": [
          {
            "text": "- createSurrealOrderRepository (factory) calls: generateOrderId, calculateOrderTotal, parseSingleOrder, mapValidOrders",
            "lineNumber": 39
          },
          {
            "text": "- mapValidOrders, parseSingleOrder call validateAndParseOrder (arrow chain)",
            "lineNumber": 40
          },
          {
            "text": "- Fix reordered 5; 9 violations persist",
            "lineNumber": 41
          },
          {
            "text": "- Arrow function dep chain not fully captured in topo sort",
            "lineNumber": 42
          },
          {
            "lineNumber": 43
          },
          {
            "text": "### src/infrastructure/surreal/wishlist-repository.ts (FM2)",
            "lineNumber": 44
          },
          {
            "text": "- addItemToWishlist, removeItemFromWishlist call findByUserId",
            "lineNumber": 45
          },
          {
            "text": "- findByUserId calls parseSingleWishlist; createSurrealWishlistRepository calls all",
            "lineNumber": 46
          },
          {
            "text": "- Arrow function ordering",
            "lineNumber": 47
          },
          {
            "lineNumber": 48
          },
          {
            "text": "### src/instrumentation.ts (FM4)",
            "lineNumber": 49
          },
          {
            "text": "- createSpan calls loadOpenTelemetry, setSpanAttributes, recordSpanError",
            "lineNumber": 50
          },
          {
            "text": "- Fix reordered 0 then 2 in different runs; violations persist",
            "lineNumber": 51
          },
          {
            "lineNumber": 52
          },
          {
            "text": "### src/services/email.ts (FM3/FM4)",
            "lineNumber": 53
          },
          {
            "text": "- sendOrderReceiptEmail calls renderOrderReceiptText / createTransporter",
            "lineNumber": 54
          },
          {
            "text": "- Fix reordered 2; violations flip between runs",
            "lineNumber": 55
          },
          {
            "lineNumber": 56
          },
          {
            "text": "### src/utils/rate-limiting.ts (FM2/FM4)",
            "lineNumber": 57
          },
          {
            "text": "- createRateLimit calls setRateLimitHeaders (2 call sites), generateRateLimitKey, createRateLimitError",
            "lineNumber": 58
          },
          {
            "text": "- Fix reordered 3; createRateLimit calls setRateLimitHeaders persists",
            "lineNumber": 59
          },
          {
            "lineNumber": 60
          },
          {
            "text": "## Gap Summary",
            "lineNumber": 61
          },
          {
            "lineNumber": 62
          },
          {
            "text": "1. **Fixer uses forEachChild(sourceFile)** - nested functions never reach reorder pipeline",
            "lineNumber": 63
          },
          {
            "text": "2. **Fixer rebuilds deps independently** - does not use analyzer call graph; extraction may differ",
            "lineNumber": 64
          },
          {
            "text": "3. **Topo sort reversal** - may not minimize violations when DAG has multiple valid orderings",
            "lineNumber": 65
          },
          {
            "text": "4. **No idempotency** - fixâ†’analyze loop oscillates (22â†”27) instead of converging to 0",
            "lineNumber": 66
          }
        ]
      },
      "score": 0.07088050246238708
    }
  ]
}
```
Status: **completed**


</details>
</tool-use>

---





---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2** â€¢ Run command: cd /home/graff/WebstormProjects/stepdown-rule && bd ready</summary>

```bash
cd /home/graff/WebstormProjects/stepdown-rule && bd ready
```

```

ðŸ“‹ Ready work (5 issues with no blockers):

1. [â— P1] [bug] stepdown-rule-77q: Fix idempotency issue in ff-elysia tool
2. [â— P1] [bug] stepdown-rule-0om: Fixer6: Fix/analyze loop non-idempotent
3. [â— P1] [bug] stepdown-rule-hje: Fixer8: Analyzer and fixer use separate code paths
4. [â— P1] [bug] stepdown-rule-aad: Fixer: 22 persistent violations in ff-elysia - failure mode taxonomy
5. [â— P2] [feature] stepdown-rule-uj1: Add project rule: each analysis must have a fix implementation


```
</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/WebstormProjects/stepdown-rule/.beads/subagent-assignments.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/WebstormProjects/stepdown-rule/package.json</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Reviewing bead tasks**

I'm looking at the ready work list to identify the next bead issue to tackle. </details></think>

---





---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2** â€¢ Run command: cd /home/graff/WebstormProjects/stepdown-rule && bd show stepdown-rule-uj1 && bd dep list stepdown-rule-uj1</summary>

```bash
cd /home/graff/WebstormProjects/stepdown-rule && bd show stepdown-rule-uj1 && bd dep list stepdown-rule-uj1
```

```

â—‹ stepdown-rule-uj1 Â· Add project rule: each analysis must have a fix implementation   [â— P2 Â· OPEN]
Owner: Joshua Pendragon Â· Type: feature
Created: 2026-02-13 Â· Updated: 2026-02-13


stepdown-rule-uj1 has no dependencies

```
</details>
</tool-use>

---

<tool-use data-tool-type="shell" data-tool-name="run_terminal_command_v2">
<details><summary>Tool use: **run_terminal_command_v2** â€¢ Run command: cd /home/graff/WebstormProjects/stepdown-rule && bd show stepdown-rule-hje && bd dep list stepdown-rule-hje</summary>

```bash
cd /home/graff/WebstormProjects/stepdown-rule && bd show stepdown-rule-hje && bd dep list stepdown-rule-hje
```

```

â—‹ stepdown-rule-hje [BUG] Â· Fixer8: Analyzer and fixer use separate code paths   [â— P1 Â· OPEN]
Owner: Joshua Pendragon Â· Type: bug
Created: 2026-02-13 Â· Updated: 2026-02-13

DESCRIPTION
Fixer does not consume analyzer output. fixFiles calls analyzeFiles but only uses result.file and violation/circular counts - not the actual violations or call graph. fixParsedFile rebuilds deps via extractDependenciesFor. Mismatch: analyzer finds violations fixer never addresses; fixer may extract different deps. Evidence: same file fixed but different violations on next analysis.


stepdown-rule-hje has no dependencies

```
</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/WebstormProjects/stepdown-rule/docs/PRD.md</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Reviewing work items**

I'm prioritizing the next bead set by reviewing the ready work items and their dependencies. 

**Refactoring fixer**

I'm refactoring the fixer to consume analyzer output instead of using separate code paths. </details></think>

---


Inspecting the analyzerâ€“fixer architecture to understand the issue:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/WebstormProjects/stepdown-rule/src/cli.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "analyzeFiles|fixParsedFile|fixFiles",
  "path": "/home/graff/WebstormProjects/stepdown-rule/src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "analyzeFiles|fixParsedFile|fixFiles",
    "path": "/home/graff/WebstormProjects/stepdown-rule/src",
    "outputMode": "content",
    "workspaceResults": {
      "/home/graff/WebstormProjects/stepdown-rule": {
        "content": {
          "matches": [
            {
              "file": "src/fixer.ts",
              "matches": [
                {
                  "lineNumber": 2,
                  "content": "import { analyzeFiles } from \"./analyzer\";"
                },
                {
                  "lineNumber": 6,
                  "content": "export async function fixFiles("
                },
                {
                  "lineNumber": 12,
                  "content": "\tconst analysisResults = await analyzeFiles(patterns, config);"
                },
                {
                  "lineNumber": 24,
                  "content": "\tresult: Awaited&lt;ReturnType&lt;typeof analyzeFiles&gt;&gt;[0],"
                },
                {
                  "lineNumber": 82,
                  "content": "\tconst fixResult = fixParsedFile(originalContent, filePath, _config);"
                },
                {
                  "lineNumber": 91,
                  "content": "export function fixParsedFile(content: string, filePath: string, _config: Config): FixResult {"
                }
              ]
            },
            {
              "file": "src/analyzer.ts",
              "matches": [
                {
                  "lineNumber": 13,
                  "content": "export async function analyzeFiles("
                }
              ]
            },
            {
              "file": "src/cli.ts",
              "matches": [
                {
                  "lineNumber": 4,
                  "content": "import { analyzeFiles } from \"./analyzer\";"
                },
                {
                  "lineNumber": 6,
                  "content": "import { fixFiles } from \"./fixer\";"
                },
                {
                  "lineNumber": 62,
                  "content": "\tconst results = await analyzeFiles(getPatterns(patterns), config, fileService);"
                },
                {
                  "lineNumber": 125,
                  "content": "\tconst fixResults = await fixFiles(getPatterns(patterns), config, fileService);"
                }
              ]
            }
          ],
          "totalLines": 11,
          "totalMatchedLines": 11
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/WebstormProjects/stepdown-rule/src/fixer.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/WebstormProjects/stepdown-rule/src/analyzer.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** â€¢ Searched codebase "undefined" â€¢ **7** results in **1** directory</summary>

Directory: **/home/graff/WebstormProjects/stepdown-rule** (7 files)

| File |
|------|
| `tests/idempotency.test.ts` |
| `tests/fixer.test.ts` |
| `tests/nested-functions.test.ts` |
| `tests/analyzer-specific-lines.test.ts` |
| `tests/fixer-error-cases.test.ts` |
| `tests/analyzer-edge-cases.test.ts` |
| `tests/analyzer.test.ts` |

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Fixing analyzer call**

I'm correcting the analyzer call to include the fileService parameter. I'm adjusting the analyzer call to pass fileService instead of creating its own instance. 

**Refactoring fixer**

I'm refactoring the fixer to consume analyzer's output instead of building its own dependency graph. I'm updating the fixer to align with analyzer's output as per the acceptance criteria. 

I'm adjusting the fixer API to accept analyzer data directly instead of recomputing it. </details></think>

---


Checking `FileService.parseFile` usage and types:


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/WebstormProjects/stepdown-rule/src/types.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/WebstormProjects/stepdown-rule/src/services/types.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** â€¢ Read file: /home/graff/WebstormProjects/stepdown-rule/tests/fixer.test.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Analyzing file resolution**

The analyzer and fixer use different FileService instances, which may lead to inconsistent file resolution due to differing ignore patterns. 

**Aligning file services**

I'm ensuring both analyzer and fixer use the same FileService instance with consistent ignore patterns. I'm aligning the dependency graph extraction between analyzer and fixer by either adding call graph to AnalysisResult or extracting shared dependency logic. I'm exporting call graph data from analyzer and deriving dependencies per function for the fixer. </details></think>

---

