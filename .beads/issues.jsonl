{"id":"stepdown-rule-0om","title":"Fixer6: Fix/analyze loop non-idempotent","description":"Running stepdown-rule then --fix repeatedly does not converge. In ff-elysia: 22 violations → fix → 27 violations → fix → 22. Violations oscillate between runs instead of reaching 0. Root cause: fixer reordering creates new violations (Fixer3) while resolving others; topo sort does not minimize total violations.","status":"closed","priority":1,"issue_type":"bug","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T16:36:11.23608977-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:27:52.525886791-06:00","closed_at":"2026-02-13T17:27:52.525886791-06:00","close_reason":"77q+bead fixtures converge; 96h resolves oscillation"}
{"id":"stepdown-rule-1e0","title":"Fixer2: Dependency graph incompleteness - partial reordering","description":"Root cause: The fixer's dependency graph (buildDependencyGraph in fixer.ts) does not capture all function relationships. When building the graph at lines 204-221, it may miss functions that are defined after they're called or not properly link all callers to their callees.\n\nEvidence: The fixer reports 'reordered N functions' but violations still remain. For example, cart-composition.ts shows 'reordered 0 functions' yet violations persist where composeCartDomain (line 47) calls sessionStoreToRepository (line 22).\n\nThe dependency extraction (extractDependenciesFor at line 229) may not be finding all call sites, especially for complex call patterns in factory functions that create objects with methods.","status":"closed","priority":0,"issue_type":"bug","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T16:33:56.290416984-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T16:59:12.855014652-06:00","closed_at":"2026-02-13T16:59:12.855014652-06:00","close_reason":"Verified: extractDependenciesFor finds deps in returned object method bodies (ts.forEachChild traverses). Added regression test."}
{"id":"stepdown-rule-1r9","title":"Refactor: Naming and analyzer micro-refactors","description":"analyzer: Rename violations_for_function to violationsForFunction (camelCase). filterOutCircularViolations: build functionsInCycles with new Set(circularDependencies.flat()). findFunctionNode: remove or shorten 'simplified implementation' comment per comment policy. fixer extractFunctionName: use node.name.getText(sourceFile) where type is already narrowed (remove redundant ?.).","acceptance_criteria":"camelCase naming; flat() for cycle set; comment removed/shortened; optional chaining fixed; bun test and typecheck pass","notes":"Description typo fix: first word should be 'analyzer' (no leading space).","status":"closed","priority":2,"issue_type":"task","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T17:37:04.258721188-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:41:00.998755238-06:00","closed_at":"2026-02-13T17:41:00.998755238-06:00","close_reason":"violationsForFunction; flat(); comment trim; optional chaining","dependencies":[{"issue_id":"stepdown-rule-1r9","depends_on_id":"stepdown-rule-2v3","type":"parent-child","created_at":"2026-02-13T17:37:20.228263429-06:00","created_by":"Joshua Pendragon"}]}
{"id":"stepdown-rule-1vw","title":"Refactor: FixResult duplication - createUnfixedResult helper","description":"In fixer.ts, introduce createUnfixedResult(file: string, errors: string[]): FixResult returning { file, fixed: false, originalContent: '', fixedContent: '', reordered: 0, errors }. Use it in createNoViolationsResult, createCircularDependencyResult, and the fixFileWithErrorHandling catch block. Single place for unfixed result shape.","acceptance_criteria":"createUnfixedResult used in all three call sites; FixResult shape unchanged; bun test and typecheck pass","status":"closed","priority":1,"issue_type":"task","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T17:37:02.559064723-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:41:00.27979921-06:00","closed_at":"2026-02-13T17:41:00.27979921-06:00","close_reason":"createUnfixedResult in 3 call sites","dependencies":[{"issue_id":"stepdown-rule-1vw","depends_on_id":"stepdown-rule-2v3","type":"parent-child","created_at":"2026-02-13T17:37:20.180457772-06:00","created_by":"Joshua Pendragon"}]}
{"id":"stepdown-rule-27g","title":"Fixe1: Arrow functions in const declarations not properly reordered","description":"Root cause: The fixer does not properly track arrow functions assigned to const variables in its dependency graph. When building the dependency graph in fixer.ts, arrow functions like 'const mapValidOrders = (...) =\u003e ...' are categorized but the topological sort doesn't handle them correctly. When functions like validateAndParseOrder are moved to fix violations for one caller, it creates new violations for arrow functions that call it.\n\nExample: src/infrastructure/surreal/order-repository.ts has mapValidOrders (line 118) calling validateAndParseOrder (line 106). The fixer reordered some functions but left this violation. Similarly in wishlist-repository.ts with parseSingleWishlist calling validateWishlist.\n\nImpact: Arrow functions in const declarations are not being reordered correctly, leaving violations unfixed.","status":"closed","priority":0,"issue_type":"bug","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T16:33:51.554300487-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:02:43.391508495-06:00","closed_at":"2026-02-13T17:02:43.391508495-06:00","close_reason":"Fixed: populate functionNames before extracting deps; factory+arrow consts now order correctly"}
{"id":"stepdown-rule-2v3","title":"Refactor: Clean code and architecture review (epic)","description":"Epic for refactors from clean code/architecture review: shared AST utils, FixResult helper, naming and micro-refactors, config loader sync, optional return type normalization. Goal: concision, expressiveness, maintainability; no functional or performance regressions.","acceptance_criteria":"All child beads (vyi, 1vw, 1r9, 5aw, 46z) completed; vet passes","status":"closed","priority":1,"issue_type":"epic","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T17:37:12.516408874-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:41:02.876504738-06:00","closed_at":"2026-02-13T17:41:02.876504738-06:00","close_reason":"All 5 refactor beads done; vet pass"}
{"id":"stepdown-rule-46z","title":"Refactor: Normalize checkVariableDeclaration return type (optional)","description":"analyzer checkVariableDeclaration currently returns string | null | undefined. Normalize to string | null (treat 'not a variable statement' as null) so callers do not handle undefined, or document the three-way contract. Low priority; do after core refactor beads.","acceptance_criteria":"Return type string | null or documented; call sites updated; bun test and typecheck pass","status":"closed","priority":2,"issue_type":"task","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T17:37:07.366438408-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:41:02.314191106-06:00","closed_at":"2026-02-13T17:41:02.314191106-06:00","close_reason":"checkVariableDeclaration string | null; caller !== null","dependencies":[{"issue_id":"stepdown-rule-46z","depends_on_id":"stepdown-rule-2v3","type":"parent-child","created_at":"2026-02-13T17:37:20.317863434-06:00","created_by":"Joshua Pendragon"}]}
{"id":"stepdown-rule-5aw","title":"Refactor: Config loader - getFullConfigJsonSchema sync + static import","description":"In config/loader.ts: static import ConfigSchema from ./schema; change getFullConfigJsonSchema from async to sync, return ConfigSchema.toJsonSchema(). Removes dynamic import and simplifies API. Note: breaking if any caller awaits it.","acceptance_criteria":"getFullConfigJsonSchema is sync; static import from ./schema; callers updated if any; bun test and typecheck pass","status":"closed","priority":2,"issue_type":"task","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T17:37:05.737784035-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:41:01.628782813-06:00","closed_at":"2026-02-13T17:41:01.628782813-06:00","close_reason":"getFullConfigJsonSchema sync; static import ./schema","dependencies":[{"issue_id":"stepdown-rule-5aw","depends_on_id":"stepdown-rule-2v3","type":"parent-child","created_at":"2026-02-13T17:37:20.273354889-06:00","created_by":"Joshua Pendragon"}]}
{"id":"stepdown-rule-77q","title":"Fix idempotency issue in ff-elysia tool","description":"Ran analysis tool in ff-elysia project and found it's not idempotent. See ff-elysia-output.md for details.","status":"closed","priority":1,"issue_type":"bug","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T01:34:44.602136563-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:17:53.235106803-06:00","closed_at":"2026-02-13T17:17:53.235106803-06:00","close_reason":"Added ff-elysia integration test; converges when ff-elysia available (skips if not)"}
{"id":"stepdown-rule-96h","title":"Fixer3: Reordering creates new violations (global opt issue)","description":"Root cause: The topological sort in the fixer performs LOCAL optimization (fixing one function's dependencies) without considering GLOBAL impact. When it reorders validateAndParseOrder to fix violations from createSurrealOrderRepository calling it, it creates NEW violations because the arrow functions (mapValidOrders, parseSingleOrder) now call a function that appears above them.\n\nThe topological sort at lines 261-298 in fixer.ts doesn't use a true dependency-aware ordering that minimizes violations across ALL functions. It simply reverses a standard topological sort which assumes callees should come before callers - opposite of stepdown rule.\n\nExample: In order-repository.ts - fixing createSurrealOrderRepository's violations by moving helper functions creates new violations with the arrow functions that call those same helpers.","status":"closed","priority":0,"issue_type":"bug","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T16:33:57.08382976-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T16:56:26.409160715-06:00","closed_at":"2026-02-13T16:56:26.409160715-06:00","close_reason":"Stable topo sort: use source order as tiebreaker when DAG has multiple valid orderings. Reduces ping-pong; bead fixtures converge."}
{"id":"stepdown-rule-aad","title":"Fixer: 22 persistent violations in ff-elysia - failure mode taxonomy","description":"Master reference for violations remaining after stepdown-rule --fix. See .beads/22-violations-analysis.md. Failures map to: FM1 Nested in callbacks (session) -\u003e db8; FM2 Arrow const ordering (order-repo, wishlist) -\u003e 27g; FM3 Fix creates new violations (cart, container) -\u003e 96h; FM4 Dep graph gap -\u003e 1e0; FM5 Mutual pairs (product-handlers) -\u003e 96h. New beads: 0om idempotency, aka top-level-only, hje analyzer-fixer divergence.","status":"closed","priority":1,"issue_type":"bug","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T16:36:17.301804746-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:27:52.574084734-06:00","closed_at":"2026-02-13T17:27:52.574084734-06:00","close_reason":"All children resolved"}
{"id":"stepdown-rule-aka","title":"Fixer7: Fixer only processes sourceFile direct children","description":"Functions nested inside VariableStatement initializers (e.g. inside .derive() callback) never enter the fixer pipeline. session.ts: getSessionId, ensureSessionCookie inside sessionPlugin = new Elysia().derive(()=\u003e{...}). categorizeNodes uses ts.forEachChild(sourceFile) - nested blocks not traversed for function extraction. Root cause of Fixer5 (db8).","status":"closed","priority":1,"issue_type":"bug","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T16:36:13.722493929-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T16:41:04.870970102-06:00","closed_at":"2026-02-13T16:41:04.870970102-06:00","close_reason":"Completed: transformNestedBlocks reorders functions inside ArrowFunction/FunctionExpression/FunctionDeclaration bodies (e.g. .derive() callbacks)"}
{"id":"stepdown-rule-db8","title":"Fixer5: Nested/inline functions inside .derive() blocks not detected","description":"Root cause: The analyzer's extractFunctions (analyzer.ts lines 52-79) only looks for top-level function declarations and variable statements. Functions defined inside method chains like .derive(), .on(), .decorate(), or other Elysia plugin methods are nested inside these call expressions and not captured as top-level functions.\n\nExample: In src/plugins/session.ts line 39, 'ensureSessionCookie' is defined inside the .derive() chain. The analyzer doesn't see it as a top-level function that can be reordered. The violation 'ensureSessionCookie calls getSessionId which appears above it' persists because the fixer cannot reorder inline functions.\n\nThe findContainingFunction at line 734 correctly identifies these as nested, but there's no mechanism to extract and reorder them.","status":"closed","priority":1,"issue_type":"bug","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T16:33:58.266972258-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T16:47:13.9818857-06:00","closed_at":"2026-02-13T16:47:13.9818857-06:00","close_reason":"Verified: analyzer extracts nested functions from callbacks; fixer (aka) reorders them. Tests added."}
{"id":"stepdown-rule-hje","title":"Fixer8: Analyzer and fixer use separate code paths","description":"Fixer does not consume analyzer output. fixFiles calls analyzeFiles but only uses result.file and violation/circular counts - not the actual violations or call graph. fixParsedFile rebuilds deps via extractDependenciesFor. Mismatch: analyzer finds violations fixer never addresses; fixer may extract different deps. Evidence: same file fixed but different violations on next analysis.","status":"closed","priority":1,"issue_type":"bug","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T16:36:13.768294564-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:10:52.724299417-06:00","closed_at":"2026-02-13T17:10:52.724299417-06:00","close_reason":"Completed"}
{"id":"stepdown-rule-obe","title":"Fixer4: Non-exported vs exported variable functions handled inconsistently","description":"Root cause: In analyzer.ts line 66, there's different handling for exported vs non-exported variable statements: 'if (ts.isVariableStatement(node) \u0026\u0026 !hasExportModifier(node))'. This means exported arrow functions are handled differently from non-exported ones.\n\nThe fixer likely has similar logic (though less visible) that treats exported functions differently. This can lead to inconsistent behavior where some violations are detected but not fixed, or different tracking for exported vs non-exported functions.\n\nEvidence: The pattern appears in multiple files where the fixer reports 0 functions reordered but violations still exist (e.g., cart-composition.ts, container.ts). The analyzer may correctly identify the violation but the fixer may not recognize these functions as needing reordering due to export handling differences.","status":"closed","priority":1,"issue_type":"bug","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T16:33:57.836985014-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T16:39:04.7198771-06:00","closed_at":"2026-02-13T16:39:04.7198771-06:00","close_reason":"Completed: removed hasExportModifier filter in extractFunctions, set isExported correctly in createVariableFunctionInfo"}
{"id":"stepdown-rule-uj1","title":"Add project rule: each analysis must have a fix implementation","status":"closed","priority":2,"issue_type":"feature","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T01:34:44.764870505-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:29:06.896415584-06:00","closed_at":"2026-02-13T17:29:06.896415584-06:00","close_reason":"AGENTS rule + violation-coverage module + regression test"}
{"id":"stepdown-rule-vyi","title":"Refactor: Add shared AST utils (isFunctionLike, getPosition)","description":"Add src/ast-utils.ts with: (1) isFunctionLike(node) - arrow or function expression, single name used by analyzer and fixer; (2) getPosition(sourceFile, node) returning 1-based { line, column }. Wire analyzer to replace isArrowFunctionOrFunctionExpression and repeated getLineAndCharacterOfPosition boilerplate; wire fixer to replace isFunctionExpression. Preserve 1-based semantics and all call sites.","acceptance_criteria":"ast-utils.ts exists; analyzer and fixer import and use it; bun test and typecheck pass; no behavior change","status":"closed","priority":1,"issue_type":"task","owner":"pendragon.josh@gmail.com","created_at":"2026-02-13T17:37:01.048469653-06:00","created_by":"Joshua Pendragon","updated_at":"2026-02-13T17:40:59.593638372-06:00","closed_at":"2026-02-13T17:40:59.593638372-06:00","close_reason":"ast-utils.ts added; analyzer+fixer wired; tests pass","dependencies":[{"issue_id":"stepdown-rule-vyi","depends_on_id":"stepdown-rule-2v3","type":"parent-child","created_at":"2026-02-13T17:37:20.135493213-06:00","created_by":"Joshua Pendragon"}]}
